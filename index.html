<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>RPG Quest Board â€” Tavern (Lock top-right, Edit bottom-left, Delete bottom-right)</title>
<style>
  :root{
    --bg1:#7a4a0c; --bg2:#3b2908; --panel:#2a1f0e; --ink:#f9f4e8;
    --muted:#cbb98f;
    --border:rgba(248,235,197,.25);
    --paper:#f4e4c1; --paper-ink:#2f2616;
    --accent:#9b6b21; --accent-2:#e2ad40; --green:#2da36a; --amber:#fbbf24; --indigo:#6366f1;
    --searchbg: rgba(255,255,255,.06);
    --midpaper:#e9d9b5;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:var(--ink);
       font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans JP',sans-serif}
  header{position:sticky;top:0;background:rgba(35,26,9,.75);backdrop-filter:blur(6px);
         border-bottom:1px solid var(--border);z-index:20}
  .wrap{max-width:1120px;margin:0 auto;padding:10px 14px;display:flex;align-items:center;gap:10px}
  h1{font-size:18px;margin:0;font-weight:800;letter-spacing:.3px}
  .btn{appearance:none;border:1px solid var(--border);background:var(--searchbg);color:var(--ink);
       padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn:hover{background:rgba(255,255,255,.12)}
  .btn.small{padding:6px 10px;font-size:12px;border-radius:9px}
  .btn.danger{background:#9a1f1f;border-color:#7f1717}
  .btn.danger:hover{background:#b32626}
  .btn.ghost{background:transparent}
  .grid{display:grid;grid-template-columns:1fr;gap:16px;padding:16px}
  @media(min-width:980px){.grid{grid-template-columns:1fr 2fr}}
  .card{background:rgba(0,0,0,.18);border:1px solid var(--border);border-radius:16px;overflow:hidden}
  .card.hardwood{background:rgba(0,0,0,.22)}
  .card h2{margin:0;padding:12px 14px;border-bottom:1px solid var(--border);font-size:15px}
  .card .content{padding:12px 14px}
  .row{display:flex;gap:8px;align-items:center}
  .space{flex:1}
  .col{display:flex;flex-direction:column;gap:8px}
  input, select, textarea{width:100%;padding:9px 11px;border-radius:10px;border:1px solid var(--border);
      background:var(--searchbg);color:var(--ink)}
  select option{ color:#000; background:#fff; }
  textarea{min-height:70px;resize:vertical}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px}
  .b-amber{background:rgba(251,191,36,.10);color:#7a5a12}
  .b-indigo{background:rgba(99,102,241,.10);color:#30335e}
  .b-green{background:rgba(16,185,129,.12);color:#115b44}
  .b-slate{background:rgba(148,163,184,.14);color:#374151}
  .b-tag{background:var(--searchbg);color:#564223}
  .b-exptext{background:var(--searchbg);color:var(--muted)}
  .progress{height:8px;background:rgba(255,255,255,.12);border-radius:999px;overflow:hidden}
  .progress>i{display:block;height:100%;background:linear-gradient(90deg,#e9b161,#e9d861)}
  .tabs{display:grid;grid-template-columns:repeat(6,1fr);gap:6px}
  .tab{padding:6px 8px;text-align:center;border:1px solid var(--border);border-radius:999px;background:var(--searchbg);cursor:pointer;font-size:12px}
  .tab.active{background:rgba(255,255,255,.16)}
  .search{position:relative}
  .search input{padding-left:30px}
  .search:before{content:'ğŸ”';position:absolute;left:8px;top:50%;transform:translateY(-50%);opacity:.7}
  .list{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:620px){.list{grid-template-columns:1fr 1fr}}
  .quest{background:var(--paper);color:var(--paper-ink);border:1px solid #e5d7ae;border-radius:12px;padding:10px;
         box-shadow:0 8px 18px rgba(0,0,0,.18); position:relative}
  .quest.locked{border-style:double; opacity:0.95}
  .quest.dragging{opacity:.6;outline:2px dashed #b8872a}
  .handle{cursor:grab;user-select:none;font-size:16px;line-height:1; padding:4px 8px; border-radius:8px; background:#ead7aa; color:#5a4726}
  .handle.disabled{opacity:.35; cursor:not-allowed}
  .quest h3{margin:0 0 6px 0;font-size:15px;color:#2a1f0e}
  .desc{color:#443418}
  .unlocks{color:#5a4828;font-size:13px;margin-top:4px}
  .muted{color:var(--muted)}
  .split{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:980px){.split{grid-template-columns:1fr 2fr}}
  .drawer{position:fixed;inset:0;display:none}
  .drawer.open{display:block}
  .drawer .panel{position:absolute;inset:0 35% 0 0;background:#1c1407;border-right:1px solid var(--border);overflow:auto;z-index:50}
  @media(max-width:980px){.drawer .panel{inset:0;max-width:460px}}
  .drawer .shade{position:absolute;inset:0;background:rgba(0,0,0,.35)}
  .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:var(--searchbg)}
  .subtabs{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
  .subtab{padding:6px 8px;text-align:center;border:1px solid var(--border);border-radius:999px;background:var(--searchbg);cursor:pointer;font-size:12px}
  .subtab.active{background:rgba(255,255,255,.16)}
  .row.end{justify-content:flex-end}
  .hint{font-size:12px;color:#a38959}
  .box{background:var(--midpaper); border:1px solid var(--border); border-radius:10px; padding:6px 10px; display:inline-flex; align-items:center; gap:6px}
  .corner-btn{position:absolute; top:8px; right:8px; background:var(--searchbg); border:1px solid var(--border); border-radius:10px; padding:6px 8px; cursor:pointer}
  .corner-btn.lock{color:#d8caa6}
  .corner-btn.lock.active{color:#ffe08a}
  .corner-btn:hover{background:rgba(255,255,255,.12)}
  .disabled{opacity:.5; pointer-events:none}
  .sp-row{display:flex; align-items:center; gap:10px; justify-content:space-between; padding:6px 0; border-bottom:1px dashed rgba(0,0,0,.1)}
  .sp-name{min-width:7em}
  .sp-ctrl{display:flex; align-items:center; gap:6px}
  .sp-ctrl .arrow{border:1px solid var(--border); background:var(--searchbg); padding:4px 8px; border-radius:8px; cursor:pointer}
  .sp-ctrl .arrow.disabled{opacity:.5; pointer-events:none}
  .sp-num{min-width:2em; text-align:center; background:var(--midpaper); border:1px solid var(--border); border-radius:8px; padding:2px 8px; color:var(--paper-ink)}
  .sp-total{min-width:2.5em; text-align:right; font-weight:700; color:#5a4726}
  .sp-footer{display:flex; justify-content:space-between; align-items:center; margin-top:8px}
  .sp-remain{color:#ffe08a; font-weight:700}
  .footer-row{display:flex; align-items:center; gap:8px; margin-top:8px}
  .footer-row .spacer{flex:1}
</style>

<style>
  /* Hide old floating auth/sync toolbar completely */
  #syncFloat, #sbShadowHost { display:none !important; }
</style>


  <script type="module" id="fb-sdk-loader">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
  import {
    getFirestore, collection, doc, setDoc, getDoc, getDocs, serverTimestamp,
    runTransaction, onSnapshot, query, orderBy, deleteDoc, writeBatch
  } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

  // TODO: ã‚ãªãŸã® firebaseConfig ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
  const firebaseConfig = {
    apiKey: "AIzaSyDw8IRU5sjphX0gowwJ2oKeOgtqaxe5hfY",
    authDomain: "quest-board-d5ed7.firebaseapp.com",
    projectId: "quest-board-d5ed7",
    storageBucket: "quest-board-d5ed7.firebasestorage.app",
    messagingSenderId: "307394427906",
    appId: "1:307394427906:web:2ff0bc69fcd95291aa7b1b",
    measurementId: "G-9VHW6CHXV7"
  };

  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  window.firebaseAuth = auth;
  window.firebaseDb   = db;

  function getLS(key){
    try { return JSON.parse(localStorage.getItem(key) || "null"); } catch { return null; }
  }
  function setLS(key, val){
    try { localStorage.setItem(key, JSON.stringify(val)); } catch {}
  }

  function exportLocalState(){
    const quests  = (window.quests ?? getLS(window.LS_Q ?? "LS_Q")) || [];
    const profile = (window.profile ?? getLS(window.LS_P ?? "LS_P")) || {};
    return { quests, profile };
  }
  async function importLocalState(state){
    if(!state) return;
    if (state.quests)  { window.quests  = state.quests;  setLS(window.LS_Q ?? "LS_Q", state.quests); }
    if (state.profile) { window.profile = state.profile; setLS(window.LS_P ?? "LS_P", state.profile); }
    if (typeof window.render === "function") window.render();
  }

  function latestDoc(uid){
    return doc(db, "users", uid, "snapshots", "latest");
  }

  async function fbPush(){
    const user = auth.currentUser; if(!user) return false;
    const payload = { ...exportLocalState(), updatedAt: serverTimestamp(), appVer: "fb-v1" };
    await setDoc(latestDoc(user.uid), payload, { merge: true });
    return true;
  }
  async function fbPull(){
    const user = auth.currentUser; if(!user) return false;
    const snap = await getDoc(latestDoc(user.uid));
    if (!snap.exists()) return false;
    const data = snap.data();
    await importLocalState({ quests: data.quests || [], profile: data.profile || {} });
    return true;
  }

  window.fbPush = fbPush;
  window.fbPull = fbPull;

  const userStatusEl = document.getElementById("userStatus");
  const loginBtnEl   = document.getElementById("loginBtn");
  const logoutBtnEl  = document.getElementById("logoutBtn");

  function showLoggedIn(u){
    if(userStatusEl) userStatusEl.textContent = `ã‚ˆã†ã“ã: ${u.email ?? u.uid}`;
    if(loginBtnEl) loginBtnEl.style.display = "inline-block";
    if(logoutBtnEl) logoutBtnEl.style.display = "inline-block";
    if(loginBtnEl) loginBtnEl.textContent = "åŒæœŸä¿å­˜(PUSH)";
  }
  function showLoggedOut(){
    if(userStatusEl) userStatusEl.textContent = "ã‚²ã‚¹ãƒˆ";
    if(loginBtnEl) { loginBtnEl.style.display = "inline-block"; loginBtnEl.textContent = "ã‚µã‚¤ãƒ³ã‚¤ãƒ³"; }
    if(logoutBtnEl) logoutBtnEl.style.display = "none";
  }

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      showLoggedIn(user);
      try { await fbPull(); } catch(e){ console.warn("auto pull failed", e); }
      if (typeof window.save === "function" && !window.__savePatchedForFB__) {
        const originalSave = window.save;
        window.save = function(){
          const r = originalSave.apply(this, arguments);
          fbPush().catch(()=>{});
          return r;
        };
        window.__savePatchedForFB__ = true;
      }
      if (loginBtnEl && !loginBtnEl.__fbBound){
        loginBtnEl.__fbBound = true;
        loginBtnEl.addEventListener("click", ()=> fbPush().then(()=>alert("PUSHå®Œäº†")).catch(e=>alert("PUSHå¤±æ•—:"+e)));
      }
    } else {
      showLoggedOut();
      if (loginBtnEl && !loginBtnEl.__guestBound){
        loginBtnEl.__guestBound = true;
        loginBtnEl.addEventListener("click", async ()=>{
          try {
            await signInWithPopup(auth, new GoogleAuthProvider());
          }
          catch(e){
            alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: " + (e?.message || e));
          }
        });
      }
    }
  });

  if (logoutBtnEl) {
    logoutBtnEl.addEventListener("click", async () => {
      try { await signOut(auth); alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ"); }
      catch (e) { alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¤±æ•—: " + (e?.message || e)); }
    });
  }
</script>

</head>
<body>
<header>
  <div class="wrap">
    <button id="adminBtn" class="btn" title="é‹å–¶ãƒ¢ãƒ¼ãƒ‰ / ç·¨é›†ãƒ¢ãƒ¼ãƒ‰">â˜°</button>
    <h1>RPG Quest Board</h1>
    <div class="space"></div>

    <span id="userStatus" style="margin-right:10px;"></span>
    <button id="loginBtn" class="btn" style="display:none;">ãƒ­ã‚°ã‚¤ãƒ³</button>
    <button id="logoutBtn" class="btn" style="display:none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>

    <button id="toggleEdit" class="btn">ç·¨é›†ãƒ¢ãƒ¼ãƒ‰: OFF</button>
    <button id="resetBtn" class="btn">åˆæœŸåŒ–</button>
  </div>
</header>

<main class="wrap" style="padding-top:16px">
  <div style="width:100%">
    <div class="tabs" id="mainTabs" style="grid-template-columns:repeat(2,1fr)">
      <div class="tab active" data-v="quests">ã‚¯ã‚¨ã‚¹ãƒˆ</div>
      <div class="tab" data-v="status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
    </div>

    <section id="pageQuests" class="split" style="margin-top:12px">
      <div class="col">
        <div class="card hardwood">
          <h2>å†’é™ºè€…ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h2>
          <div class="content col">
            <div class="row">
              <span class="badge b-exptext">LV <b id="lv">1</b></span>
              <span class="muted">EXP <b id="expProg">0</b>/<b id="expNeed">100</b>ï¼ˆæ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¾ã§ï¼‰</span>
            </div>
            <div class="progress"><i id="expBar" style="width:0%"></i></div>
            <div class="row" style="margin-top:6px">
              <span class="badge b-exptext">ğŸ’° <b id="gold">0</b> Gold</span>
            </div>
          </div>
        </div>

        <div class="card hardwood">
          <h2>è·æ¥­ãƒã‚¤ãƒ³ãƒˆæŒ¯ã‚Šåˆ†ã‘</h2>
          <div class="content">
            <div id="jobAlloc"></div>
            <div class="sp-footer">
              <button id="sp_apply" class="btn">æ±ºå®š</button>
              <div>æ®‹ã‚Šãƒã‚¤ãƒ³ãƒˆï¼š<span id="sp_remain" class="sp-remain">0</span></div>
            </div>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="card hardwood">
          <h2>ã‚¯ã‚¨ã‚¹ãƒˆæ²ç¤ºæ¿</h2>
          <div class="content col">
            <div class="row" style="flex-wrap:wrap; gap:8px">
              <div id="filters" class="tabs">
                <div data-v="ACTIVE" class="tab active">é€²è¡Œä¸­</div>
                <div data-v="ARCHIVED" class="tab">å®Œäº†</div>
                <div data-v="REPEATABLE" class="tab">åå¾©</div>
                <div data-v="ONEOFF" class="tab">å˜ç™º</div>
                <div data-v="ALL" class="tab">å…¨éƒ¨</div>
                <div data-v="HARD" class="tab">HARD+</div>
              </div>
              <div class="search" style="flex:1">
                <input id="search" placeholder="æ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«/èª¬æ˜/ã‚«ãƒ†ã‚´ãƒªï¼‰">
              </div>
            </div>
            <div class="hint">ãƒ’ãƒ³ãƒˆï¼šç·¨é›†ãƒ¢ãƒ¼ãƒ‰ONã§ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ä¸¦ã¹æ›¿ãˆã€ã‚«ãƒ¼ãƒ‰å³ä¸Šã®éµã§ãƒ­ãƒƒã‚¯ã€‚ç·¨é›†ã¯å³ä¸‹ã€å‰Šé™¤ã¯ã•ã‚‰ã«å³ç«¯ã€‚</div>
            <div id="list" class="list" style="margin-top:8px"></div>
          </div>
        </div>
      </div>
    </section>

    <section id="pageStatus" style="display:none;margin-top:12px">
      <div class="card hardwood">
        <h2>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
        <div class="content">
          <div class="grid" style="grid-template-columns:repeat(3,1fr)">
            <div class="pill">ä½“åŠ›(HP): <b id="st_hp">10</b></div>
            <div class="pill">ç­‹åŠ›(STR): <b id="st_str">1</b></div>
            <div class="pill">æ•æ·(DEX): <b id="st_dex">1</b></div>
            <div class="pill">çŸ¥åŠ›(INT): <b id="st_int">1</b></div>
            <div class="pill">æ´»åŠ›(VIT): <b id="st_vit">1</b></div>
          </div>
          <div class="row" style="margin-top:8px">
            <span class="badge b-exptext">LV <b id="lv2">1</b></span>
            <span class="muted">EXP <b id="expProg2">0</b>/<b id="expNeed2">100</b></span>
          </div>
          <div class="progress" style="margin-top:4px"><i id="expBar2" style="width:0%"></i></div>
          <div class="row" style="margin-top:8px">
            <span class="badge b-exptext">ğŸ’° <b id="gold2">0</b> Goldï¼ˆç·æ‰€æŒï¼‰</span>
          </div>

          <div class="subtabs" id="statusTabs" style="margin-top:12px">
            <div class="subtab active" data-v="overview">æ¦‚è¦</div>
            <div class="subtab" data-v="cleared">ã‚¯ãƒªã‚¢æ¸ˆã¿</div>
            <div class="subtab" data-v="library">è·æ¥­/ã‚¹ã‚­ãƒ«</div>
          </div>

          <div id="st_overview" style="margin-top:10px" class="muted">ã‚¯ã‚¨ã‚¹ãƒˆé”æˆã§è§£æ”¾ã•ã‚Œã‚‹è·æ¥­ã‚„ã‚¹ã‚­ãƒ«ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¸Šæ˜‡ã¯ã“ã“ã«åæ˜ ã•ã‚Œã¾ã™ã€‚</div>
          <div id="st_cleared" style="display:none;margin-top:10px"></div>
          <div id="st_library" style="display:none;margin-top:10px" class="grid" ></div>
        </div>
      </div>
    </section>
  </div>
</main>

<div id="drawer" class="drawer">
  <div class="panel" id="drawerPanel">
    <div class="wrap" style="padding:10px 14px;border-bottom:1px solid var(--border);position:sticky;top:0;background:#1c1407;z-index:51">
      <div style="font-weight:700">é‹å–¶ãƒ¢ãƒ¼ãƒ‰</div>
      <button id="closeDrawer" class="btn small" style="margin-left:auto">é–‰ã˜ã‚‹</button>
    </div>
    <div class="grid" style="grid-template-columns:1fr;padding:12px">
      <div class="card">
        <h2>ã‚¯ã‚¨ã‚¹ãƒˆè¿½åŠ  / ç·¨é›†</h2>
        <div class="content col">
          <input id="f_title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä¾‹: æœ¬ã‚’30åˆ†èª­ã‚€ï¼‰" autofocus>
          <textarea id="f_desc" placeholder="èª¬æ˜ï¼ˆä»»æ„ï¼‰"></textarea>
          <input id="f_cat" placeholder="ã‚«ãƒ†ã‚´ãƒªï¼ˆä»»æ„ï¼šå¥åº·/å­¦ç¿’/åˆ¶ä½œ ãªã©ï¼‰">
          <div class="row">
            <div class="col" style="flex:1">
              <span class="muted" style="font-size:12px">é›£æ˜“åº¦</span>
              <select id="f_diff">
                <option value="EASY">EASY</option>
                <option value="NORMAL" selected>NORMAL</option>
                <option value="HARD">HARD</option>
                <option value="EPIC">EPIC</option>
              </select>
            </div>
            <div class="col" style="width:120px">
              <span class="muted" style="font-size:12px">EXP</span>
              <input id="f_exp" type="number" value="50">
            </div>
            <div class="col" style="width:120px">
              <span class="muted" style="font-size:12px">Gold</span>
              <input id="f_gold" type="number" value="20">
            </div>
          </div>
          <label><input id="f_rep" type="checkbox" checked> åå¾©ã‚¯ã‚¨ã‚¹ãƒˆ</label>

          <div class="card" style="background:rgba(0,0,0,.12)">
            <h2>è§£æ”¾ãƒ«ãƒ¼ãƒ«ï¼ˆä»»æ„ï¼‰</h2>
            <div class="content col">
              <label><input id="u_use" type="checkbox"> ã“ã®ã‚¯ã‚¨ã‚¹ãƒˆã®ã‚¯ãƒªã‚¢å›æ•°ã§ä½•ã‹ã‚’è§£æ”¾/ä¸Šæ˜‡ã•ã›ã‚‹</label>
              <div class="row">
                <div class="col" style="width:140px">
                  <span class="muted" style="font-size:12px">ã—ãã„å€¤ï¼ˆå›ï¼‰</span>
                  <input id="u_threshold" type="number" value="5">
                </div>
                <div class="col">
                  <span class="muted" style="font-size:12px">ç¨®é¡</span>
                  <select id="u_type">
                    <option value="stat">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¸Šæ˜‡</option>
                    <option value="skill">ã‚¹ã‚­ãƒ«è§£æ”¾</option>
                    <option value="job">è·æ¥­è§£æ”¾</option>
                  </select>
                </div>
              </div>
              <div id="u_stat" class="row">
                <div class="col"><span class="muted" style="font-size:12px">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</span>
                  <select id="u_statkey">
                    <option value="hp">ä½“åŠ›(HP)</option>
                    <option value="str">ç­‹åŠ›(STR)</option>
                    <option value="dex">æ•æ·(DEX)</option>
                    <option value="int">çŸ¥åŠ›(INT)</option>
                    <option value="vit">æ´»åŠ›(VIT)</option>
                  </select>
                </div>
                <div class="col" style="width:120px"><span class="muted" style="font-size:12px">å¢—åŠ é‡</span>
                  <input id="u_statamt" type="number" value="1">
                </div>
              </div>
              <div id="u_skill" class="row" style="display:none">
                <input id="u_skillkey" placeholder="ã‚¹ã‚­ãƒ«IDï¼ˆä»»æ„ï¼‰">
                <input id="u_skilltitle" placeholder="ã‚¹ã‚­ãƒ«å">
              </div>
              <div id="u_job" class="row" style="display:none">
                <input id="u_jobkey" placeholder="è·æ¥­IDï¼ˆä»»æ„ï¼‰">
                <input id="u_jobtitle" placeholder="è·æ¥­å">
              </div>
            </div>
          </div>

          <div class="row end" style="gap:8px">
            <button id="addBtn" class="btn">æ²ç¤ºæ¿ã«è²¼ã‚‹</button>
            <button id="saveBtn" class="btn" style="display:none">æ›´æ–°ã‚’ä¿å­˜</button>
            <button id="cancelEditBtn" class="btn ghost" style="display:none">ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="shade" id="shade"></div>
</div>

<script>
(function(){

    window.appState = window.appState || {};

  const LS_Q = 'rpg-quest-todo-v8';
  const LS_P = 'rpg-quest-profile-v4';

  function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
  const now = Date.now();
  const SEED = [
    { id:uid(), order:0, title:'æœ¬ã‚’30åˆ†èª­ã‚€', description:'ç©èª­ã‹ã‚‰1å†Šé¸ã‚“ã§30åˆ†ã€‚ã‚¹ãƒãƒ›ã¯åˆ¥éƒ¨å±‹ã¸ã€‚', category:'çŸ¥è­˜', difficulty:'NORMAL', exp:50, gold:20, repeatable:true, timesCompleted:0, archived:false, createdAt: now, locked:false,
      unlocks:[ {threshold:5, grant:{type:'skill', key:'quickread', title:'ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ¼ãƒ‰'}}, {threshold:10, grant:{type:'job', key:'scholar', title:'å­¦è¡“å£«'}} ] },
    { id:uid(), order:1, title:'10åˆ†ã‚¹ãƒˆãƒ¬ãƒƒãƒ', description:'è‚©ã¨è‚¡é–¢ç¯€ã‚’ä¸­å¿ƒã«ã€‚', category:'å¥åº·', difficulty:'EASY', exp:30, gold:10, repeatable:true, timesCompleted:0, archived:false, createdAt: now, locked:false,
      unlocks:[ {threshold:7, grant:{type:'stat', key:'dex', amount:1}}, {threshold:14, grant:{type:'job', key:'trainer', title:'é›éŒ¬å®¶'}} ] },
    { id:uid(), order:2, title:'ä½œæ¥­é…ä¿¡ã®å°æœ¬ãƒ¡ãƒ¢ã‚’ä½œã‚‹', description:'è¦‹å‡ºã—ã ã‘ã§ã‚‚OKã€‚RPGæ²ç¤ºæ¿é¢¨ã«ã€‚', category:'åˆ¶ä½œ', difficulty:'HARD', exp:120, gold:60, repeatable:false, timesCompleted:0, archived:false, createdAt: now, locked:false,
      unlocks:[ {threshold:1, grant:{type:'skill', key:'focus', title:'é›†ä¸­åŠ›'}} ] },
  ];

  let quests = [];
  let profile = {
    gold:0, exp:0,
    stats:{ hp:10, str:1, dex:1, int:1, vit:1 },
    skills:[], jobs:[], appliedUnlocks:[],
    skillPoints:{ unspent: 2, perJob: {} },
    lastLevel: 1
  };
  try{
    quests = JSON.parse(localStorage.getItem(LS_Q)) || SEED;
    const p = JSON.parse(localStorage.getItem(LS_P)); if(p) profile = Object.assign(profile, p);
    quests.forEach((q,i)=>{ if(typeof q.order!=='number') q.order = i; if(typeof q.locked!=='boolean') q.locked=false; });
    if(!profile.skillPoints) profile.skillPoints = {unspent:0, perJob:{}};
    if(typeof profile.lastLevel!=='number') profile.lastLevel = 1;
  }catch(e){ quests = SEED; }

  const el = id => document.getElementById(id);
  const E = {
    adminBtn: el('adminBtn'), drawer: el('drawer'), shade: el('shade'), closeDrawer: el('closeDrawer'), drawerPanel: el('drawerPanel'),
    resetBtn: el('resetBtn'), toggleEdit: el('toggleEdit'),
    mainTabs: el('mainTabs'), pageQuests: el('pageQuests'), pageStatus: el('pageStatus'),
    lv: el('lv'), expProg: el('expProg'), expNeed: el('expNeed'), expBar: el('expBar'), gold: el('gold'),
    filters: el('filters'), search: el('search'), list: el('list'),
    st_hp: el('st_hp'), st_str: el('st_str'), st_dex: el('st_dex'), st_int: el('st_int'), st_vit: el('st_vit'),
    lv2: el('lv2'), expProg2: el('expProg2'), expNeed2: el('expNeed2'), expBar2: el('expBar2'), gold2: el('gold2'),
    statusTabs: el('statusTabs'), st_overview: el('st_overview'), st_cleared: el('st_cleared'), st_library: el('st_library'),
    f_title: el('f_title'), f_desc: el('f_desc'), f_cat: el('f_cat'), f_diff: el('f_diff'), f_exp: el('f_exp'), f_gold: el('f_gold'), f_rep: el('f_rep'),
    u_use: el('u_use'), u_threshold: el('u_threshold'), u_type: el('u_type'), u_stat: el('u_stat'), u_skill: el('u_skill'), u_job: el('u_job'),
    u_statkey: el('u_statkey'), u_statamt: el('u_statamt'), u_skillkey: el('u_skillkey'), u_skilltitle: el('u_skilltitle'), u_jobkey: el('u_jobkey'), u_jobtitle: el('u_jobtitle'),
    addBtn: el('addBtn'), saveBtn: el('saveBtn'), cancelEditBtn: el('cancelEditBtn'),
    jobAlloc: el('jobAlloc'), sp_apply: el('sp_apply'), sp_remain: el('sp_remain')
  };

  let filter = 'ACTIVE';
  let editMode = false;
  let editingId = null;
  let pending = {}; // jobKey -> add amount

  function levelFromExp(exp){ let lvl=1, need=100, left=exp; while(left>=need){ left-=need; lvl++; need+=50; } return {level:lvl,toNext:need,progress:left}; }

  function save(){
    if (window.firebaseAuth.currentUser && window.firebaseDb) {
      // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜
      window.appState.saveUserData(window.firebaseAuth.currentUser.uid);
    } else {
      localStorage.setItem(LS_Q, JSON.stringify(quests));
      localStorage.setItem(LS_P, JSON.stringify(profile));
      console.log("Not logged in. Data saved to localStorage.");
      window.appState.renderApp();
    }
  }

  function skillPointsForLevel(L){
    const band = Math.floor((L-1)/10);
    const a = 1 + band, b = 2 + band;
    return (L % 2 === 1) ? a : b;
  }
  function grantLevelUpPoints(prevLevel, newLevel){
    if(newLevel<=prevLevel) return 0;
    let gained = 0;
    for(let L=prevLevel+1; L<=newLevel; L++){ gained += skillPointsForLevel(L); }
    profile.skillPoints.unspent = (profile.skillPoints.unspent||0) + gained;
    profile.lastLevel = newLevel;
    return gained;
  }

  function applyUnlocksIfAny(q, updatedTimes){
    if(!q.unlocks || !q.unlocks.length) return;
    q.unlocks.forEach((rule, idx)=>{
      const already = profile.appliedUnlocks.some(a=> a.questId===q.id && a.index===idx);
      if(!already && updatedTimes >= rule.threshold){
        if(rule.grant.type==='stat'){ const k=rule.grant.key; profile.stats[k]=(profile.stats[k]||0)+(rule.grant.amount||0); }
        else if(rule.grant.type==='skill'){ if(!profile.skills.some(s=> s.key===rule.grant.key)) profile.skills.push({key:rule.grant.key,title:rule.grant.title}); }
        else if(rule.grant.type==='job'){ if(!profile.jobs.some(s=> s.key===rule.grant.key)) profile.jobs.push({key:rule.grant.key,title:rule.grant.title}); }
        profile.appliedUnlocks.push({ questId:q.id, index:idx });
      }
    });
  }

  async function loadUserDataFromFirestore(uid) {
    if (!window.firebaseDb || !uid) return;
    console.log(`Loading data for user: ${uid}`);

    // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å‚ç…§ã‚’æ­£ã—ãå–å¾— â˜…â˜…â˜…
    const userDocRef = doc(collection(window.firebaseDb, 'users'), uid);
    const userQuestsCollectionRef = collection(userDocRef, 'quests');
    // â˜…â˜…â˜… ã“ã“ã¾ã§ä¿®æ­£ â˜…â˜…â˜…

    try {
      const userDoc = await getDoc(userDocRef);
      if (userDoc.exists) {
        const data = userDoc.data();
        if (data.profile) profile = Object.assign(profile, data.profile);
      } else {
        console.log("No user profile data in Firestore for this user. Using default or local data.");
        await window.appState.saveUserData(uid); // åˆå›ä¿å­˜
      }

      // Questsã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
      // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: query()ã§orderByã‚’é©ç”¨ â˜…â˜…â˜…
      onSnapshot(query(userQuestsCollectionRef, orderBy('order')), snapshot => {
      // â˜…â˜…â˜… ã“ã“ã¾ã§ä¿®æ­£ â˜…â˜…â˜…
        quests = [];
        snapshot.forEach(doc => {
          quests.push(doc.data());
        });
        console.log("Quests loaded from Firestore:", quests);
        window.appState.renderApp();
      }, error => {
        console.error("Error fetching quests:", error);
      });

    } catch (error) {
      console.error("Error loading user data from Firestore:", error);
    }
  }

   // Firebaseãƒ‡ãƒ¼ã‚¿ä¿å­˜é–¢æ•°
  async function saveUserDataToFirestore(uid) {
    if (!window.firebaseDb || !uid) return;
    console.log(`Saving data for user: ${uid}`);
    const userDocRef = doc(collection(window.firebaseDb, 'users'), uid);
    try {
      await setDoc(userDocRef, { profile: profile }, { merge: true });
      console.log("Profile data saved to Firestore.");
    } catch (error) {
      console.error("Error saving user data to Firestore:", error);
    }
  }

  async function completeQuestById(id){
    if (!window.firebaseAuth.currentUser || !window.firebaseDb) {
      const q = quests.find(x=> x.id===id); if(!q) return;
      const before = levelFromExp(profile.exp).level;
      q.timesCompleted += 1;
      if(!q.repeatable) q.archived = true;
      profile.gold += q.gold;
      profile.exp += q.exp;
      applyUnlocksIfAny(q, q.timesCompleted);
      const after = levelFromExp(profile.exp).level;
      const gained = grantLevelUpPoints(before, after);
      save();
      if(gained>0){ setTimeout(()=> alert('ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ã‚¹ã‚­ãƒ«ãƒã‚¤ãƒ³ãƒˆ +'+gained+' ã‚’ç²å¾—ã—ã¾ã—ãŸã€‚'), 0); }
      return;
    }

    const q = quests.find(x=> x.id===id); if(!q) return;

    // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: runTransactionã«dbã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æ¸¡ã™ â˜…â˜…â˜…
    try {
      await runTransaction(window.firebaseDb, async (transaction) => {
        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã®å‚ç…§ã‚’ä¿®æ­£ â˜…â˜…â˜…
        const userQuestsRef = collection(doc(collection(window.firebaseDb, 'users'), window.firebaseAuth.currentUser.uid), 'quests');
        const questRef = doc(userQuestsRef, id);
        const userDocRef = doc(collection(window.firebaseDb, 'users'), window.firebaseAuth.currentUser.uid);

        const questDoc = await transaction.get(questRef);
        if (!questDoc.exists) {
          throw new Error("Quest does not exist!");
        }
        const currentQuest = questDoc.data();

        const userProfileDoc = await transaction.get(userDocRef);
        const currentProfile = userProfileDoc.exists ? userProfileDoc.data().profile : profile;
        // â˜…â˜…â˜… ã“ã“ã¾ã§ä¿®æ­£ â˜…â˜…â˜…

        const updatedTimesCompleted = currentQuest.timesCompleted + 1;
        const updatedArchived = !currentQuest.repeatable ? true : currentQuest.archived;
        transaction.update(questRef, {
          timesCompleted: updatedTimesCompleted,
          archived: updatedArchived
        });

        let updatedProfile = Object.assign({}, currentProfile);
        updatedProfile.gold = (updatedProfile.gold || 0) + currentQuest.gold;
        updatedProfile.exp = (updatedProfile.exp || 0) + currentQuest.exp;

        if (currentQuest.unlocks && currentQuest.unlocks.length) {
          currentQuest.unlocks.forEach((rule, idx) => {
            const appliedUnlocks = updatedProfile.appliedUnlocks || [];
            const already = appliedUnlocks.some(a => a.questId === currentQuest.id && a.index === idx);
            if (!already && updatedTimesCompleted >= rule.threshold) {
              if (rule.grant.type === 'stat') { updatedProfile.stats[rule.grant.key] = (updatedProfile.stats[rule.grant.key] || 0) + (rule.grant.amount || 0); }
              else if (rule.grant.type === 'skill') { if (!updatedProfile.skills.some(s => s.key === rule.grant.key)) updatedProfile.skills.push({ key: rule.grant.key, title: rule.grant.title }); }
              else if (rule.grant.type === 'job') { if (!updatedProfile.jobs.some(s => s.key === rule.grant.key)) updatedProfile.jobs.push({ key: rule.grant.key, title: rule.grant.title }); }
              appliedUnlocks.push({ questId: currentQuest.id, index: idx });
              updatedProfile.appliedUnlocks = appliedUnlocks;
            }
          });
        }

        const beforeLevel = levelFromExp(currentProfile.exp || 0).level;
        const afterLevel = levelFromExp(updatedProfile.exp).level;
        const gainedPoints = grantLevelUpPoints(beforeLevel, afterLevel);

        if (gainedPoints > 0) {
          updatedProfile.skillPoints.unspent = (updatedProfile.skillPoints.unspent || 0) + gainedPoints;
          updatedProfile.lastLevel = afterLevel;
          setTimeout(() => alert('ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ã‚¹ã‚­ãƒ«ãƒã‚¤ãƒ³ãƒˆ +' + gainedPoints + ' ã‚’ç²å¾—ã—ã¾ã—ãŸã€‚'), 0);
        }

        transaction.set(userDocRef, { profile: updatedProfile }, { merge: true });
        profile = updatedProfile;
      });

      console.log("Quest and Profile updated via transaction.");
    } catch (error) {
      console.error("Transaction failed:", error);
      alert(`ã‚¯ã‚¨ã‚¹ãƒˆé”æˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
    }
  }

  async function removeQuestById(id){
    if (!window.firebaseAuth.currentUser || !window.firebaseDb) {
      quests = quests.filter(q=> q.id!==id); save();
      return;
    }
    try {
      // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å‚ç…§ã‚’æ­£ã—ãå–å¾— â˜…â˜…â˜…
      const questDocRef = doc(collection(doc(collection(window.firebaseDb, 'users'), window.firebaseAuth.currentUser.uid), 'quests'), id);
      // â˜…â˜…â˜… ã“ã“ã¾ã§ä¿®æ­£ â˜…â˜…â˜…
      await deleteDoc(questDocRef);
      console.log("Quest removed from Firestore:", id);
    } catch (error) {
      console.error("Error removing quest from Firestore:", error);
    }
  }

  async function addQuest(q){
    if (!window.firebaseAuth.currentUser || !window.firebaseDb) {
      if(typeof q.order!=='number') q.order = quests.length; quests = [q,...quests]; save();
      return;
    }
    try {
      // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å‚ç…§ã‚’æ­£ã—ãå–å¾— â˜…â˜…â˜…
      const questRef = doc(collection(doc(collection(window.firebaseDb, 'users'), window.firebaseAuth.currentUser.uid), 'quests'), q.id);
      await setDoc(questRef, q);
      // â˜…â˜…â˜… ã“ã“ã¾ã§ä¿®æ­£ â˜…â˜…â˜…
      console.log("Quest added to Firestore:", q.id);
    } catch (error) {
      console.error("Error adding quest to Firestore:", error);
    }
  }

  function matchFilter(q){
    if(filter==='ACTIVE' && (q.archived || (!q.repeatable && q.timesCompleted>0))) return false;
    if(filter==='ARCHIVED' && !(q.archived || (!q.repeatable && q.timesCompleted>0))) return false;
    if(filter==='REPEATABLE' && !q.repeatable) return false;
    if(filter==='ONEOFF' && q.repeatable) return false;
    if(filter==='HARD' && !(q.difficulty==='HARD'||q.difficulty==='EPIC')) return false;
    const s = E.search.value.trim().toLowerCase();
    if(s){ const hay=(q.title+' '+(q.description||'')+' '+(q.category||'')).toLowerCase(); if(!hay.includes(s)) return false; }
    return true;
  }

  function badge(html, klass=''){ return '<span class="badge '+klass+'">'+html+'</span>'; }

  function questRow(q){
    const cat = q.category ? badge(q.category, 'b-tag') : '';
    const g = badge('ğŸ’° '+q.gold+'G','b-indigo');
    const ex = badge(q.exp+'EXP','b-indigo');
    const rep = q.repeatable ? badge('åå¾© Ã—'+q.timesCompleted,'b-green') : badge('å˜ç™º '+((q.archived||q.timesCompleted>0)?'(å®Œäº†)':'(æœª)'),'b-slate');
    const diffMap = {EASY:badge('EASY','b-green'), NORMAL:badge('NORMAL','b-tag'), HARD:badge('HARD','b-amber'), EPIC:badge('EPIC','b-indigo')};
    const diff = diffMap[q.difficulty] || '';
    const unlocks = (q.unlocks && q.unlocks.length)? '<div class="unlocks">è§£æ”¾æ¡ä»¶: ' +
      q.unlocks.map(function(u,i){
        const d = (u.grant.type==='stat')?('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹+'+(u.grant.amount||0)):(u.grant.type==='job'?('è·æ¥­ã€Œ'+u.grant.title+'ã€'):('ã‚¹ã‚­ãƒ«ã€Œ'+u.grant.title+'ã€'));
        return (i? ' / ':'') + u.threshold + 'å›ã§' + d;
      }).join('')
    + '</div>' : '';

    const handle = editMode ? '<span class="handle'+(q.locked?' disabled':'')+'" data-id="'+q.id+'" title="'+(q.locked?'ãƒ­ãƒƒã‚¯ä¸­':'ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã¹æ›¿ãˆ')+'">â˜°</span>' : '';
    const lockBtn = editMode ? '<button class="corner-btn lock '+(q.locked?'active':'')+'" data-act="toggle-lock" data-id="'+q.id+'" title="'+(q.locked?'è§£é™¤':'ãƒ­ãƒƒã‚¯')+'">'+(q.locked?'ğŸ”’':'ğŸ”“')+'</button>' : '';
    const titleBox = '<span class="box" title="ãƒ¡ãƒ¢/ã‚¿ã‚°ãªã©ã«åˆ©ç”¨å¯">â–¡</span>';

    const editBtn = editMode ? '<button class="btn'+(q.locked?' disabled':'')+'" data-act="edit" data-id="'+q.id+'">ç·¨é›†</button>' : '';
    const delBtn  = editMode ? '<button class="btn danger'+(q.locked?' disabled':'')+'" data-act="del" data-id="'+q.id+'">å‰Šé™¤</button>' : '';

    return '<div class="quest '+(q.locked?'locked':'')+'" data-id="'+q.id+'" draggable="'+(editMode && !q.locked)+'">'
      + lockBtn
      + '<div class="row" style="justify-content:space-between;gap:8px">'
      +   '<div class="row" style="gap:8px">'+handle+'<h3>'+q.title+'</h3>'+titleBox+'</div>'
      + '</div>'
      + '<div class="row" style="flex-wrap:wrap;gap:6px;margin-bottom:6px">'+diff+' '+cat+' '+g+' '+ex+' '+rep+'</div>'
      + (q.description? '<div class="desc" style="white-space:pre-wrap">'+q.description+'</div>':'')
      + unlocks
      + '<div class="footer-row">'
      +   '<span class="box"><button class="btn" style="padding:4px 8px" data-act="done" data-id="'+q.id+'">é”æˆå ±å‘Š</button></span>'
      +   editBtn
      +   '<span class="spacer"></span>'
      +   delBtn
      + '</div>'
      + '</div>';
  }

  function renderProfile(){
    const lvInfo = levelFromExp(profile.exp);
    grantLevelUpPoints(profile.lastLevel||1, lvInfo.level);
    E.lv.textContent = lvInfo.level; E.expProg.textContent = lvInfo.progress; E.expNeed.textContent = lvInfo.toNext; E.expBar.style.width = Math.round((lvInfo.progress/lvInfo.toNext)*100)+'%';
    E.gold.textContent = profile.gold;
    E.lv2.textContent = lvInfo.level; E.expProg2.textContent = lvInfo.progress; E.expNeed2.textContent = lvInfo.toNext; E.expBar2.style.width = Math.round((lvInfo.progress/lvInfo.toNext)*100)+'%';
    E.gold2.textContent = profile.gold;
    E.st_hp.textContent = profile.stats.hp; E.st_str.textContent = profile.stats.str; E.st_dex.textContent = profile.stats.dex; E.st_int.textContent = profile.stats.int; E.st_vit.textContent = profile.stats.vit;
  }

  function renderBoard(){
    const arr = quests.slice().filter(matchFilter).sort(function(a,b){ return (a.order||0)-(b.order||0); });
    if(arr.length===0){ E.list.innerHTML = '<div class="muted" style="text-align:center;padding:24px">æ¡ä»¶ã«åˆã†ã‚¯ã‚¨ã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>'; return; }
    E.list.innerHTML = arr.map(questRow).join('');

    if(editMode){
      const cards = Array.from(E.list.querySelectorAll('.quest'));
      let draggingId = null;
      cards.forEach(function(card){
        if(card.classList.contains('locked')) return;
        card.addEventListener('dragstart', function(){ draggingId = card.getAttribute('data-id'); card.classList.add('dragging'); });
        card.addEventListener('dragend',   function(){ draggingId = null; card.classList.remove('dragging'); save(); });
        card.addEventListener('dragover', function(e){
          e.preventDefault();
          const over = e.currentTarget; const targetId = over.getAttribute('data-id'); if(!draggingId || targetId===draggingId) return;
          const a = quests.find(function(x){ return x.id===draggingId; }); const b = quests.find(function(x){ return x.id===targetId; });
          if(!a||!b || b.locked) return;
          const tmp = a.order; a.order = b.order; b.order = tmp;
          renderBoard();
        });
      });
    }
  }

  function renderStatusSubtabs(){
    const cleared = quests.filter(q=> q.timesCompleted>0);
    E.st_cleared.innerHTML = cleared.length ? '<div class="list">'+cleared.map(function(q){ return '<div class="quest"><h3>'+q.title+'</h3><div class="muted">ã‚¯ãƒªã‚¢å›æ•°: '+q.timesCompleted+'</div></div>'; }).join('')+'</div>' : '<div class="muted">ã¾ã ã‚¯ãƒªã‚¢æ¸ˆã¿ã®ã‚¯ã‚¨ã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
    E.st_library.innerHTML = '<div class="card"><div class="content"><div class="muted">è·æ¥­</div>'+(profile.jobs && profile.jobs.length? '<ul>'+profile.jobs.map(function(j){ return '<li>'+j.title+'</li>'; }).join('')+'</ul>':'<div class="muted">æœªè§£æ”¾</div>')+'</div></div>'
      + '<div class="card"><div class="content"><div class="muted">ã‚¹ã‚­ãƒ«</div>'+(profile.skills && profile.skills.length? '<ul>'+profile.skills.map(function(s){ return '<li>'+s.title+'</li>'; }).join('')+'</ul>':'<div class="muted">æœªè§£æ”¾</div>')+'</div></div>';
  }

  function sumPending(){ return Object.values(pending).reduce((a,b)=>a+(b||0),0); }

  function renderJobAlloc(){
    const jobs = profile.jobs || [];
    const unspent = profile.skillPoints?.unspent || 0;
    E.sp_remain.textContent = (unspent - sumPending());
    if(!jobs.length){
      E.jobAlloc.innerHTML = '<div class="muted">è·æ¥­ãŒã¾ã è§£æ”¾ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>';
      return;
    }
    const per = profile.skillPoints.perJob || {};
    const html = jobs.map(function(j){
      const cur = per[j.key] || 0;
      const pend = pending[j.key] || 0;
      return '<div class="sp-row" data-key="'+j.key+'">'
        + '<div class="sp-name">'+j.title+'</div>'
        + '<div class="sp-ctrl">'
        +   '<button class="arrow dec'+((pend<=0)?' disabled':'')+'">â—€</button>'
        +   '<span class="sp-num pend">'+pend+'</span>'
        +   '<button class="arrow inc'+((sumPending()>=unspent)?' disabled':'')+'">â–¶</button>'
        + '</div>'
        + '<div class="sp-total">'+(cur+pend)+'</div>'
        + '</div>';
    }).join('');
    E.jobAlloc.innerHTML = html;
  }

  function applyJobAlloc(){
    const unspent = profile.skillPoints.unspent || 0;
    const used = sumPending();
    if(used<=0) return;
    if(used>unspent) return;
    const per = profile.skillPoints.perJob || {};
    Object.keys(pending).forEach(function(k){
      const add = pending[k]||0;
      if(add>0){ per[k] = (per[k]||0)+add; pending[k]=0; }
    });
    profile.skillPoints.perJob = per;
    profile.skillPoints.unspent = unspent - used;
    save();
    renderJobAlloc();
  }

  function render(){
    renderProfile(); renderBoard(); renderStatusSubtabs(); renderJobAlloc();
    Array.from(E.filters.children).forEach(x=> x.classList.toggle('active', x.getAttribute('data-v')===filter));
    E.toggleEdit.textContent = 'ç·¨é›†ãƒ¢ãƒ¼ãƒ‰: ' + (editMode? 'ON':'OFF');
  }

  function openDrawer(prefillId=null){
    document.getElementById('drawer').classList.add('open');
    E.f_title.focus();
    if(prefillId){
      const q = quests.find(x=> x.id===prefillId); if(!q) return;
      if(q.locked){ alert('ã“ã®ã‚¯ã‚¨ã‚¹ãƒˆã¯ãƒ­ãƒƒã‚¯ä¸­ã§ã™ã€‚ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã¦ã‹ã‚‰ç·¨é›†ã—ã¦ãã ã•ã„ã€‚'); return; }
      editingId = q.id;
      E.addBtn.style.display='none'; E.saveBtn.style.display='inline-block'; E.cancelEditBtn.style.display='inline-block';
      E.f_title.value = q.title || '';
      E.f_desc.value = q.description || '';
      E.f_cat.value = q.category || '';
      E.f_diff.value = q.difficulty || 'NORMAL';
      E.f_exp.value = q.exp || 0;
      E.f_gold.value = q.gold || 0;
      E.f_rep.checked = !!q.repeatable;
      if(q.unlocks && q.unlocks.length>0){
        const u = q.unlocks[0];
        E.u_use.checked = true;
        E.u_threshold.value = u.threshold || 1;
        if(u.grant.type==='stat'){
          E.u_type.value='stat';
          E.u_stat.style.display='flex'; E.u_skill.style.display='none'; E.u_job.style.display='none';
          E.u_statkey.value = u.grant.key || 'hp';
          E.u_statamt.value = u.grant.amount || 1;
        } else if(u.grant.type==='skill'){
          E.u_type.value='skill';
          E.u_stat.style.display='none'; E.u_skill.style.display='flex'; E.u_job.style.display='none';
          E.u_skillkey.value = u.grant.key || '';
          E.u_skilltitle.value = u.grant.title || '';
        } else {
          E.u_type.value='job';
          E.u_stat.style.display='none'; E.u_skill.style.display='flex'; E.u_job.style.display='flex';
          E.u_jobkey.value = u.grant.key || '';
          E.u_jobtitle.value = u.grant.title || '';
        }
      } else {
        E.u_use.checked=false;
      }
    } else {
      editingId = null;
      E.addBtn.style.display='inline-block'; E.saveBtn.style.display='none'; E.cancelEditBtn.style.display='none';
      E.f_title.value=''; E.f_desc.value=''; E.f_cat.value=''; E.f_diff.value='NORMAL'; E.f_exp.value='50'; E.f_gold.value='20'; E.f_rep.checked=true;
      E.u_use.checked=false; E.u_threshold.value='5'; E.u_type.value='stat'; E.u_statkey.value='hp'; E.u_statamt.value='1'; E.u_skillkey.value=''; E.u_skilltitle.value=''; E.u_jobkey.value=''; E.u_jobtitle.value='';
      E.u_stat.style.display='flex'; E.u_skill.style.display='none'; E.u_job.style.display='none';
    }
  }
  function closeDrawer(){ document.getElementById('drawer').classList.remove('open'); }

  document.addEventListener('click', function(e){
    const t = e.target;
    if(!(t instanceof HTMLElement)) return;

    const act = t.getAttribute('data-act') || (t.parentElement && t.parentElement.getAttribute('data-act'));
    const id  = t.getAttribute('data-id')  || (t.parentElement && t.parentElement.getAttribute('data-id'));
    if(act && id){
      if(act==='done'){ completeQuestById(id); }
      if(act==='del'){
        const q = quests.find(x=> x.id===id); if(!q) return;
        if(q.locked){ alert('ãƒ­ãƒƒã‚¯ä¸­ã®ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚'); return; }
        if(confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) removeQuestById(id);
      }
      if(act==='edit'){ openDrawer(id); }
      if(act==='toggle-lock'){
        const q = quests.find(x=> x.id===id); if(!q) return;
        q.locked = !q.locked; save(); render();
      }
    }

    if(t.id==='adminBtn'){ openDrawer(null); }
    if(t.id==='closeDrawer' || t.id==='shade'){ closeDrawer(); }
    if(t.id==='toggleEdit'){ editMode = !editMode; render(); }
  });

  E.filters.addEventListener('click', e=>{
    const t = e.target; if(!(t instanceof HTMLElement)) return;
    const v = t.getAttribute('data-v'); if(!v) return; filter=v; render();
  });
  E.search.addEventListener('input', render);

  E.mainTabs.addEventListener('click', e=>{
    const t = e.target; if(!(t instanceof HTMLElement)) return;
    const v = t.getAttribute('data-v'); if(!v) return;
    Array.from(E.mainTabs.children).forEach(x=> x.classList.toggle('active', x.getAttribute('data-v')===v));
    if(v==='quests'){ E.pageQuests.style.display='grid'; E.pageStatus.style.display='none'; }
    else{ E.pageQuests.style.display='none'; E.pageStatus.style.display='block'; }
  });

  E.statusTabs.addEventListener('click', e=>{
    const t = e.target; if(!(t instanceof HTMLElement)) return;
    const v = t.getAttribute('data-v'); if(!v) return;
    Array.from(E.statusTabs.children).forEach(x=> x.classList.toggle('active', x.getAttribute('data-v')===v));
    E.st_overview.style.display = v==='overview'?'block':'none';
    E.st_cleared.style.display  = v==='cleared'?'block':'none';
    E.st_library.style.display  = v==='library'?'grid':'none';
  });

  document.getElementById('u_type').addEventListener('change', ()=>{
    const t = document.getElementById('u_type').value;
    document.getElementById('u_stat').style.display = t==='stat'?'flex':'none';
    document.getElementById('u_skill').style.display = t==='skill'?'flex':'none';
    document.getElementById('u_job').style.display = t==='job'?'flex':'none';
  });

  E.addBtn.addEventListener('click', ()=>{
    const title = E.f_title.value.trim(); if(!title) return;
    const q = {
      id: uid(),
      order: quests.length? Math.max(...quests.map(x=> x.order||0))+1 : 0,
      title,
      description: E.f_desc.value.trim() || undefined,
      category: E.f_cat.value.trim() || undefined,
      difficulty: E.f_diff.value,
      exp: Math.max(1, Math.round(Number(E.f_exp.value)||0)),
      gold: Math.max(0, Math.round(Number(E.f_gold.value)||0)),
      repeatable: !!E.f_rep.checked,
      timesCompleted: 0, archived:false, createdAt: Date.now(), locked:false,
    };
    if(E.u_use.checked){
      const threshold = Math.max(1, Math.round(Number(E.u_threshold.value)||1));
      const t = E.u_type.value;
      if(t==='stat'){
        q.unlocks = [{ threshold, grant: { type:'stat', key:E.u_statkey.value, amount: Math.max(1, Math.round(Number(E.u_statamt.value)||1)) } }];
      }else if(t==='skill'){
        q.unlocks = [{ threshold, grant: { type:'skill', key:E.u_skillkey.value||uid(), title:E.u_skilltitle.value||'æ–°ã‚¹ã‚­ãƒ«' } }];
      }else{
        q.unlocks = [{ threshold, grant: { type:'job', key:E.u_jobkey.value||uid(), title:E.u_jobtitle.value||'æ–°è·æ¥­' } }];
      }
    }
    addQuest(q);
    E.f_title.value=''; E.f_desc.value=''; E.f_cat.value=''; E.f_diff.value='NORMAL'; E.f_exp.value='50'; E.f_gold.value='20'; E.f_rep.checked=true;
    document.getElementById('u_use').checked=false; document.getElementById('u_threshold').value='5'; document.getElementById('u_type').value='stat';
    document.getElementById('u_statkey').value='hp'; document.getElementById('u_statamt').value='1';
    document.getElementById('u_skillkey').value=''; document.getElementById('u_skilltitle').value='';
    document.getElementById('u_jobkey').value=''; document.getElementById('u_jobtitle').value='';
    E.f_title.focus();
  });

  E.saveBtn.addEventListener('click', ()=>{
    if(!editingId) return;
    const q = quests.find(x=> x.id===editingId); if(!q) return;
    q.title = E.f_title.value.trim() || q.title;
    q.description = E.f_desc.value.trim() || undefined;
    q.category = E.f_cat.value.trim() || undefined;
    q.difficulty = E.f_diff.value;
    q.exp = Math.max(1, Math.round(Number(E.f_exp.value)||0));
    q.gold = Math.max(0, Math.round(Number(E.f_gold.value)||0));
    q.repeatable = !!E.f_rep.checked;

    if(document.getElementById('u_use').checked){
      const threshold = Math.max(1, Math.round(Number(document.getElementById('u_threshold').value)||1));
      const t = document.getElementById('u_type').value;
      if(t==='stat'){
        q.unlocks = [{ threshold, grant: { type:'stat', key:document.getElementById('u_statkey').value, amount: Math.max(1, Math.round(Number(document.getElementById('u_statamt').value)||1)) } }];
      }else if(t==='skill'){
        q.unlocks = [{ threshold, grant: { type:'skill', key:document.getElementById('u_skillkey').value||uid(), title:document.getElementById('u_skilltitle').value||'æ–°ã‚¹ã‚­ãƒ«' } }];
      }else{
        q.unlocks = [{ threshold, grant: { type:'job', key:document.getElementById('u_jobkey').value||uid(), title:document.getElementById('u_jobtitle').value||'æ–°è·æ¥­' } }];
      }
    } else {
      q.unlocks = [];
    }

    save(); render();
    closeDrawer();
  });

  E.cancelEditBtn.addEventListener('click', ()=>{ closeDrawer(); });
  E.sp_apply.addEventListener('click', applyJobAlloc);

   E.resetBtn.addEventListener('click', async ()=>{
    if(!confirm('å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿï¼ˆãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®å ´åˆã¯Firebaseãƒ‡ãƒ¼ã‚¿ã‚‚åˆæœŸåŒ–ã•ã‚Œã¾ã™ï¼‰')) return;

    if (window.firebaseAuth.currentUser && window.firebaseDb) {
      const uid = window.firebaseAuth.currentUser.uid;
      try {
        const userDocRef = doc(collection(window.firebaseDb, 'users'), uid);
        await setDoc(userDocRef, {
          profile: { gold:0, exp:0, stats:{ hp:10, str:1, dex:1, int:1, vit:1 }, skills:[], jobs:[], appliedUnlocks:[], skillPoints:{unspent:2, perJob:{}}, lastLevel:1 }
        });

        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: getDocs()ã¨writeBatch()ã‚’ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«é–¢æ•°ã¨ã—ã¦å‘¼ã³å‡ºã™ â˜…â˜…â˜…
        const questsCollectionRef = collection(userDocRef, 'quests');
        const snapshot = await getDocs(questsCollectionRef);
        const batch = writeBatch(window.firebaseDb);
        snapshot.docs.forEach(d => {
          batch.delete(d.ref);
        });
        await batch.commit();

        const newQuestsBatch = writeBatch(window.firebaseDb);
        SEED.forEach(qData => {
          const newQuestRef = doc(questsCollectionRef, qData.id);
          newQuestsBatch.set(newQuestRef, qData); // setDocã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‚ç…§ã¨ãƒ‡ãƒ¼ã‚¿ã‚’å¼•æ•°ã«å–ã‚‹
        });
        await newQuestsBatch.commit();
        // â˜…â˜…â˜… ã“ã“ã¾ã§ä¿®æ­£ â˜…â˜…â˜…

        alert('Firebaseã®ãƒ‡ãƒ¼ã‚¿ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸã€‚');
      } catch (error) {
        console.error('Firebaseãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        alert('Firebaseãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
      }
    } else {
      const now = Date.now();
      quests = SEED.map((q,i)=> Object.assign({}, q, {order:i, createdAt: now, locked:false}));
      profile = { gold:0, exp:0, stats:{ hp:10, str:1, dex:1, int:1, vit:1 }, skills:[], jobs:[], appliedUnlocks:[], skillPoints:{unspent:2, perJob:{}}, lastLevel:1 };
      pending = {};
      localStorage.setItem(LS_Q, JSON.stringify(quests));
      localStorage.setItem(LS_P, JSON.stringify(profile));
      alert('ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸã€‚');
      window.appState.renderApp();
    }
  });

  function openAdmin(){ openDrawer(null); }
  document.getElementById('adminBtn').addEventListener('click', openAdmin);
  document.getElementById('closeDrawer').addEventListener('click', closeDrawer);
  document.getElementById('shade').addEventListener('click', closeDrawer);
  document.getElementById('drawerPanel').addEventListener('keydown', (e)=> e.stopPropagation(), {capture:true});
  document.getElementById('drawerPanel').addEventListener('pointerdown', (e)=> e.stopPropagation(), {capture:true});

  window.appState.renderApp = render;
  window.appState.loadUserData = loadUserDataFromFirestore;
  window.appState.saveUserData = saveUserDataToFirestore;

})();
</script>
</body>
</html>
