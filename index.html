<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RPG Quest Board — Synced</title>
  <meta name="theme-color" content="#3b2908"/>
</head>
<body>
  <div id="app">RPG Quest Board (同期機能つき 完成版)</div>

  <!-- Supabase同期フローティングUI -->
  <div id="syncFloat" style="position:fixed;right:12px;bottom:12px;background:#0008;color:#fff;padding:8px;border-radius:8px;z-index:9999;">
    <span id="syncText">未ログイン</span>
    <button id="sbSignIn">サインイン</button>
    <button id="sbSignOut" style="display:none">サインアウト</button>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://jjyjcxswkcqtcxenytam.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqeWpjeHN3a2NxdGN4ZW55dGFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0MzYxMDEsImV4cCI6MjA3NDAxMjEwMX0.Hyp3MGsO8Aouyvctdx3QnQITPlqcLxkdeooBPhFYGEw";
    const REDIRECT_TO = "https://sekiruto.github.io/Quest-Board/";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function setState(msg){ document.getElementById("syncText").textContent = msg; }

    document.getElementById("sbSignIn").onclick = async ()=>{
      const email = prompt("メールアドレスを入力してください");
      if(!email) return;
      const { error } = await supabase.auth.signInWithOtp({ email, options:{ emailRedirectTo: REDIRECT_TO }});
      if(error) alert(error.message); else alert("メールを確認してください");
    };
    document.getElementById("sbSignOut").onclick = async ()=>{
      await supabase.auth.signOut();
      setState("未ログイン");
      document.getElementById("sbSignIn").style.display="inline-block";
      document.getElementById("sbSignOut").style.display="none";
    };

    supabase.auth.onAuthStateChange((_e,session)=>{
      const user = session?.user;
      if(user){
        setState("ログイン中: "+(user.email||user.id));
        document.getElementById("sbSignIn").style.display="none";
        document.getElementById("sbSignOut").style.display="inline-block";
      } else {
        setState("未ログイン");
        document.getElementById("sbSignIn").style.display="inline-block";
        document.getElementById("sbSignOut").style.display="none";
      }
    });
  </script>
</body>
</html>
