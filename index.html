<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>RPG Quest Board — ver.08 + Sync + Rule UI (seed6-updated)</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#3b2908">
<script>
if ('serviceWorker' in navigator) {
  addEventListener('load', ()=>navigator.serviceWorker.register('./service-worker.js').catch(()=>{}));
}
</script>
<style>
:root{
  --bg1:#7a4a0c; --bg2:#3b2908; --ink:#f9f4e8; --border:rgba(248,235,197,.25);
  --paper:#f4e4c1; --paper-ink:#2f2616; --searchbg: rgba(255,255,255,.06);
  --muted:#cbb98f; --expText:#cbb98f; --page-bg:linear-gradient(135deg,var(--bg1),var(--bg2));
}
*{box-sizing:border-box} body{margin:0;background:var(--page-bg);color:var(--ink);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans JP',sans-serif}
header{position:sticky;top:0;background:rgba(35,26,9,.75);backdrop-filter:blur(6px);border-bottom:1px solid var(--border);z-index:40}
.wrap{max-width:1120px;margin:0 auto;padding:10px 14px;display:flex;align-items:center;gap:10px}
h1{font-size:18px;margin:0;font-weight:800}
.btn{appearance:none;border:1px solid var(--border);background:var(--searchbg);color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
.btn:hover{background:rgba(255,255,255,.12)} .btn.small{padding:6px 10px;font-size:12px;border-radius:9px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap} .col{display:flex;flex-direction:column;gap:12px} .sp{flex:1}
main{max-width:1120px;margin:0 auto;padding:16px}
.grid{display:grid;grid-template-columns:1fr;gap:16px}
@media(min-width:980px){.grid{grid-template-columns:1fr 2fr}}
.card{background:rgba(0,0,0,.18);border:1px solid var(--border);border-radius:16px;overflow:hidden}
.card h2{margin:0;padding:12px 14px;border-bottom:1px solid var(--border);font-size:15px}
.content{padding:12px 14px}
input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--searchbg);color:var(--ink)}
select option{color:#000;background:#fff} textarea{min-height:72px;resize:vertical}
.pill{display:inline-flex;gap:6px;align-items:center;padding:4px 10px;border-radius:999px;background:var(--searchbg);border:1px solid var(--border)}
.badge{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px}
.b-exptext{background:var(--searchbg);color:var(--expText)} .muted{color:var(--muted)}
.progress{height:8px;background:rgba(255,255,255,.12);border-radius:999px;overflow:hidden}
.progress>i{display:block;height:100%;background:linear-gradient(90deg,#e9b161,#e9d861)}
.tabs{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
.tab{padding:6px 8px;text-align:center;border:1px solid var(--border);border-radius:999px;background:var(--searchbg);cursor:pointer;font-size:12px}
.tab.active{background:rgba(255,255,255,.16)}
.search{position:relative}
.search input{padding-left:30px}
.search:before{content:'🔎';position:absolute;left:8px;top:50%;transform:translateY(-50%);opacity:.7}
.list{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:620px){.list{grid-template-columns:1fr 1fr}}
.quest{background:var(--paper);color:var(--paper-ink);border:1px solid #e5d7ae;border-radius:12px;padding:10px 10px 44px;position:relative;box-shadow:0 8px 18px rgba(0,0,0,.18)}
.quest h3{margin:0 0 6px 0;font-size:15px;color:#2a1f0e}
.desc{color:#443418} .unlocks{color:#5a4828;font-size:13px;margin-top:4px}
.box{background:#dbcaa6;border:1px solid var(--border);border-radius:10px;padding:6px 10px;display:inline-flex;align-items:center;gap:6px}
.quest .fixedActions{position:absolute;left:10px;bottom:8px;display:flex;gap:8px;align-items:center}
.quest .editBar{position:absolute;right:10px;bottom:8px;display:none;gap:8px}
.quest.edit .editBar{display:flex}
/* Drawer */
.drawer{position:fixed;inset:0;display:none;z-index:50}
.drawer.open{display:block}
.drawer .panel{position:absolute;inset:0 35% 0 0;background:#1c1407;border-right:1px solid var(--border);overflow:auto}
@media(max-width:980px){.drawer .panel{inset:0;max-width:480px}}
.drawer .shade{position:absolute;inset:0;background:rgba(0,0,0,.35)}
.ruleBox{border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:8px}
.ruleGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:640px){.ruleGrid{grid-template-columns:1fr}}
/* Status big tiles */
.statTiles{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
.statTile{padding:14px;border:1px solid var(--border);border-radius:12px;background:rgba(255,255,255,.06);text-align:center;font-weight:800;font-size:16px}
/* Sync panel */
#syncFloat{position:fixed;right:12px;bottom:12px;z-index:9999;background:rgba(0,0,0,.55);backdrop-filter:blur(6px);color:#fff;border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:8px 10px;display:flex;gap:8px;align-items:center;font:12px/1.3 system-ui,sans-serif}
#syncFloat button{appearance:none;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.06);color:#fff;border-radius:8px;padding:6px 8px;cursor:pointer}
#syncFloat button:hover{background:rgba(255,255,255,.12)}
#syncFloat .dot{width:8px;height:8px;border-radius:50%;background:#aaa}
#syncFloat .dot.on{background:#54d38a}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <button id="adminBtn" class="btn">☰</button>
    <h1>RPG Quest Board</h1>
    <div class="sp"></div>
    <button id="toggleEdit" class="btn">編集モード: OFF</button>
    <button id="resetBtn" class="btn">初期化</button>
  </div>
</header>

<main>
  <div class="tabs" id="mainTabs">
    <div class="tab active" data-v="quests">クエスト</div>
    <div class="tab" data-v="status">ステータス</div>
  </div>

  <section id="pageQuests" class="grid" style="margin-top:12px">
    <div class="col">
      <div class="card">
        <h2>冒険者プロフィール</h2>
        <div class="content col">
          <div class="row">
            <span class="badge b-exptext">LV <b id="lv">1</b></span>
            <span class="muted">EXP <b id="expProg">0</b>/<b id="expNeed">100</b></span>
          </div>
          <div class="progress"><i id="expBar" style="width:0%"></i></div>
          <div class="row" style="margin-top:6px">
            <span class="badge b-exptext">💰 <b id="gold">0</b> Gold</span>
          </div>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card">
        <h2>クエスト掲示板</h2>
        <div class="content col">
          <div class="row" style="flex-wrap:wrap; gap:8px">
            <div id="filters" class="tabs" style="grid-template-columns:repeat(3,1fr)">
              <div data-v="ACTIVE" class="tab active">進行中</div>
              <div data-v="ARCHIVED" class="tab">完了</div>
              <div data-v="ALL" class="tab">全部</div>
            </div>
            <div class="search" style="flex:1"><input id="search" placeholder="検索（タイトル・説明）"></div>
          </div>
          <div id="list" class="list" style="margin-top:8px"></div>
        </div>
      </div>
    </div>
  </section>

  <section id="pageStatus" style="display:none;margin-top:12px">
    <div class="card">
      <h2>ステータス</h2>
      <div class="content col">
        <div class="statTiles">
          <div class="statTile">HP<br><b id="statHP">10</b></div>
          <div class="statTile">STR<br><b id="statSTR">1</b></div>
          <div class="statTile">DEX<br><b id="statDEX">1</b></div>
          <div class="statTile">INT<br><b id="statINT">1</b></div>
          <div class="statTile">VIT<br><b id="statVIT">1</b></div>
        </div>
        <div class="row" style="margin-top:6px"><span class="badge b-exptext">💰 <b id="gold2">0</b> Gold</span></div>
        <div class="tabs" id="statusTabs" style="grid-template-columns:repeat(3,1fr);margin-top:8px">
          <div class="tab active" data-v="overview">概要</div>
          <div class="tab" data-v="cleared">クリア済み</div>
          <div class="tab" data-v="jobsSkills">職業/スキル</div>
        </div>
        <div id="statusOverview" class="col" style="margin-top:8px">
          <div class="muted">クエスト達成で解放される職業やスキル、ステータス上昇はここに反映されます。</div>
        </div>
        <div id="statusCleared" class="col" style="display:none;margin-top:8px">
          <div id="clearedList" class="muted">まだありません</div>
        </div>
        <div id="statusJobsSkills" class="col" style="display:none;margin-top:8px">
          <div class="row"><h3 style="margin:0">職業</h3></div>
          <div id="jobsList" class="muted">未解放</div>
          <div class="row" style="margin-top:10px"><h3 style="margin:0">スキル</h3></div>
          <div id="skillsList" class="muted">未解放</div>
        </div>
      </div>
    </div>
  </section>
</main>

<div id="syncFloat"><span class="dot" id="syncDot"></span><span id="syncText">未ログイン</span>
<button id="sbSignIn">サインイン</button><button id="sbSignOut" style="display:none">サインアウト</button></div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const SUPABASE_URL = "https://jjyjcxswkcqtcxenytam.supabase.co";
const SUPABASE_ANON_KEY = "YOUR_ANON_KEY_HERE";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const LS_Q='rpg-quest-todo-v8', LS_P='rpg-quest-profile-v4', LS_UPDATED='rpg-updated-at';
const $ = (id)=>document.getElementById(id);
const nowIso = ()=>new Date().toISOString();
const uid = ()=>crypto.randomUUID();

function loadLocal(){
  return {
    quests: JSON.parse(localStorage.getItem(LS_Q)||'[]'),
    profile: JSON.parse(localStorage.getItem(LS_P)||'{"gold":0,"exp":0,"stats":{"HP":10,"STR":1,"DEX":1,"INT":1,"VIT":1},"skills":[],"jobs":[]}'),
    updated_at: localStorage.getItem(LS_UPDATED) || null
  };
}
function saveLocal(data){
  localStorage.setItem(LS_Q, JSON.stringify(data.quests));
  localStorage.setItem(LS_P, JSON.stringify(data.profile));
  localStorage.setItem(LS_UPDATED, data.updated_at || nowIso());
  dispatchEvent(new Event('local-updated'));
}
function levelFromExp(exp){ let lvl=1, need=100, left=exp; while(left>=need){ left-=need; lvl++; need+=50; } return {level:lvl,toNext:need,progress:left}; }

// ===== default 6 quests (UPDATED) =====
const defaultQuests = [
  { id: uid(), title:"【読書[ビギナー]】知識の芽を育てよ", category:"知識", difficulty:"EASY", gold:20, exp:30, description:"25分読書する。", repeatType:"REPEAT", timesCompleted:0, archived:false, rule:{type:"NONE"} },
  { id: uid(), title:"【読書ノービス】小さな書庫を開け", category:"知識", difficulty:"EASY", gold:30, exp:40, description:"読書を36分する。", repeatType:"REPEAT", timesCompleted:0, archived:false, rule:{type:"STAT_UP", count:7, statTarget:"INT", amount:1, repeatMode:"once"} },
  { id: uid(), title:"【瞑想[ビギナー]】静寂の扉をノックせよ", category:"精神", difficulty:"EASY", gold:5, exp:10, description:"瞑想を10分する。", repeatType:"REPEAT", timesCompleted:0, archived:false, rule:{type:"NONE"} },
  { id: uid(), title:"【瞑想ノービス】心の湖に石を投じよ", category:"精神", difficulty:"EASY", gold:25, exp:30, description:"瞑想を20分する。", repeatType:"REPEAT", timesCompleted:0, archived:false, rule:{type:"STAT_UP", count:7, statTarget:"INT", amount:1, repeatMode:"once"} },
  { id: uid(), title:"【歩行[ビギナー]】石畳を10歩進め", category:"運動", difficulty:"EASY", gold:15, exp:30, description:"20分間ウォーキングする。", repeatType:"REPEAT", timesCompleted:0, archived:false, rule:{type:"NONE"} },
  { id: uid(), title:"【歩行ノービス】朝霧の小道を往け", category:"運動", difficulty:"NORMAL", gold:25, exp:40, description:"30分間ウォーキングする。", repeatType:"REPEAT", timesCompleted:0, archived:false, rule:{type:"STAT_UP", count:5, statTarget:"VIT", amount:1, repeatMode:"each"} }
];

function questCardHTML(q){
  return `<div class="quest" data-id="${q.id}">
    <h3><span class="box">${q.title}</span></h3>
    ${q.description?`<div class="desc">${q.description}</div>`:''}
    ${q.rule?.type && q.rule.type!=="NONE" ? `<div class="unlocks">${ruleText(q.rule)}</div>`:''}
    <div class="row" style="margin-top:8px;justify-content:flex-end">
      <span class="box">${q.difficulty||'NORMAL'}</span>
      <span class="box">💰 ${q.gold||0} G</span>
      <span class="box">⭐ ${q.exp||0} XP</span>
      <span class="box">反復 ×${q.timesCompleted||0}</span>
    </div>
    <div class="fixedActions"><button class="btn small" data-act="done">達成報告</button></div>
  </div>`;
}
function ruleText(r){
  if(r.type==="STAT_UP"){ return `条件(${r.count}回)で ${r.statTarget}+${r.amount}${r.repeatMode==='each'?'
