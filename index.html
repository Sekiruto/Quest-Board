<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>RPG Quest Board â€” PWA + Supabase Auth Sync</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#3b2908">
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').catch(console.error);
      });
    }
  </script>

  <style>
    :root{
      --bg1:#7a4a0c; --bg2:#3b2908; --ink:#f9f4e8; --border:rgba(248,235,197,.25);
      --paper:#f4e4c1; --paper-ink:#2f2616; --searchbg: rgba(255,255,255,.06);
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:var(--ink);
         font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans JP',sans-serif}
    header{position:sticky;top:0;background:rgba(35,26,9,.75);backdrop-filter:blur(6px);
           border-bottom:1px solid var(--border);z-index:20}
    .wrap{max-width:960px;margin:0 auto;padding:10px 14px;display:flex;align-items:center;gap:10px}
    h1{font-size:18px;margin:0;font-weight:800;letter-spacing:.3px}
    .btn{appearance:none;border:1px solid var(--border);background:var(--searchbg);color:var(--ink);
         padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{background:rgba(255,255,255,.12)}
    main{max-width:960px;margin:0 auto;padding:16px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .list{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:640px){.list{grid-template-columns:1fr 1fr}}
    .card{background:rgba(0,0,0,.18);border:1px solid var(--border);border-radius:16px;overflow:hidden}
    .card h2{margin:0;padding:12px 14px;border-bottom:1px solid var(--border);font-size:15px}
    .content{padding:12px 14px}
    input{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--searchbg);color:var(--ink)}
    .quest{background:var(--paper);color:var(--paper-ink);border:1px solid #e5d7ae;border-radius:12px;padding:10px}
    .footer{display:flex;gap:8px;align-items:center;margin-top:8px}
    .sp{flex:1}
    .muted{opacity:.85}
    .badge{display:inline-block;border:1px solid var(--border);background:var(--searchbg);padding:2px 8px;border-radius:999px;font-size:12px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:var(--searchbg);font-size:12px}
    .warn{color:#ffd089}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>RPG Quest Board</h1>
      <div style="flex:1"></div>
      <span id="authState" class="pill">æœªãƒ­ã‚°ã‚¤ãƒ³</span>
      <button class="btn" id="signinBtn">ã‚µã‚¤ãƒ³ã‚¤ãƒ³</button>
      <button class="btn" id="signoutBtn" style="display:none">ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ</button>
      <button class="btn" id="exportBtn">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      <input type="file" id="importFile" style="display:none" accept="application/json">
      <button class="btn" id="importBtn">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
      <button class="btn" id="resetBtn">åˆæœŸåŒ–</button>
    </div>
  </header>

  <main>
    <div class="card">
      <h2>å†’é™ºè€…ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h2>
      <div class="content">
        <div class="row">
          <span class="badge">LV <b id="lv">1</b></span>
          <span class="muted">EXP <b id="expProg">0</b>/<b id="expNeed">100</b></span>
          <span class="badge">ğŸ’° <b id="gold">0</b> G</span>
          <span class="muted">åŒæœŸçŠ¶æ…‹: <b id="syncState">å¾…æ©Ÿä¸­</b></span>
        </div>
        <div class="row warn" id="rlsHint" style="display:none">â€» ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ã¿ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸã—ã¾ã™ï¼ˆRLSæœ‰åŠ¹ï¼‰</div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h2>ã‚¯ã‚¨ã‚¹ãƒˆæ²ç¤ºæ¿</h2>
      <div class="content">
        <div class="row">
          <input id="newTitle" placeholder="æ–°ã—ã„ã‚¯ã‚¨ã‚¹ãƒˆï¼ˆä¾‹ï¼šæœ¬ã‚’30åˆ†èª­ã‚€ï¼‰">
          <button class="btn" id="addBtn">è¿½åŠ </button>
        </div>
        <div class="list" id="list" style="margin-top:10px"></div>
      </div>
    </div>
  </main>

  <!-- ã“ã“ã‹ã‚‰ï¼šèªè¨¼ & åŒæœŸã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    /* ======= Supabase è¨­å®šï¼ˆç½®ãæ›ãˆã¦ãã ã•ã„ï¼‰ ======= */
    const SUPABASE_URL = "https://jjyjcxswkcqtcxenytam.supabase.co";   // â†ã‚ãªãŸã®URL
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqeWpjeHN3a2NxdGN4ZW55dGFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0MzYxMDEsImV4cCI6MjA3NDAxMjEwMX0.Hyp3MGsO8Aouyvctdx3QnQITPlqcLxkdeooBPhFYGEw";                  // â†ã‚ãªãŸã®anonã‚­ãƒ¼
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true }
    });

    /* ======= æ—¢å­˜ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã‚­ãƒ¼ï¼ˆå¿…è¦ã«å¿œã˜ã¦èª¿æ•´ï¼‰ ======= */
    const LS_Q = 'rpg-quest-todo-v13';
    const LS_P = 'rpg-quest-profile-v4';

    /* ======= ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======= */
    const E = {
      lv: document.getElementById('lv'),
      expProg: document.getElementById('expProg'),
      expNeed: document.getElementById('expNeed'),
      gold: document.getElementById('gold'),
      list: document.getElementById('list'),
      newTitle: document.getElementById('newTitle'),
      addBtn: document.getElementById('addBtn'),
      resetBtn: document.getElementById('resetBtn'),
      exportBtn: document.getElementById('exportBtn'),
      importBtn: document.getElementById('importBtn'),
      importFile: document.getElementById('importFile'),
      syncState: document.getElementById('syncState'),
      signinBtn: document.getElementById('signinBtn'),
      signoutBtn: document.getElementById('signoutBtn'),
      authState: document.getElementById('authState'),
      rlsHint: document.getElementById('rlsHint')
    };
    function uid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }
    function nowIso(){ return new Date().toISOString(); }

    function levelFromExp(exp){
      let lvl=1, need=100, left=exp;
      while(left>=need){ left-=need; lvl++; need+=50; }
      return {level:lvl,toNext:need,progress:left};
    }
    function loadLocal(){
      return {
        quests: JSON.parse(localStorage.getItem(LS_Q) || '[]'),
        profile: JSON.parse(localStorage.getItem(LS_P) || '{"gold":0,"exp":0}'),
        updated_at: localStorage.getItem('rpg-updated-at') || '1970-01-01T00:00:00.000Z'
      };
    }
    function saveLocal(data){
      localStorage.setItem(LS_Q, JSON.stringify(data.quests));
      localStorage.setItem(LS_P, JSON.stringify(data.profile));
      localStorage.setItem('rpg-updated-at', data.updated_at || nowIso());
    }

    /* ======= è¡¨ç¤º ======= */
    function render(){
      const local = loadLocal();
      const lvInfo = levelFromExp(local.profile.exp||0);
      E.lv.textContent = lvInfo.level;
      E.expProg.textContent = lvInfo.progress;
      E.expNeed.textContent = lvInfo.toNext;
      E.gold.textContent = local.profile.gold||0;
      E.list.innerHTML = (local.quests||[]).map(q => `
        <div class="quest">
          <div><b>${q.title}</b></div>
          <div class="footer">
            <button class="btn" data-act="done" data-id="${q.id}">é”æˆ</button>
            <div class="sp"></div>
            <span class="muted">${q.exp||50} EXP / ${q.gold||20} G</span>
          </div>
        </div>
      `).join('');
    }

    /* ======= åˆæœŸãƒ‡ãƒ¼ã‚¿ ======= */
    function ensureSeed(){
      const local = loadLocal();
      if((local.quests||[]).length===0){
        local.quests = [
          { id: uid(), title:'æœ¬ã‚’30åˆ†èª­ã‚€', exp:50, gold:20, repeatable:true, timesCompleted:0 },
          { id: uid(), title:'10åˆ†ã‚¹ãƒˆãƒ¬ãƒƒãƒ', exp:30, gold:10, repeatable:true, timesCompleted:0 }
        ];
        local.profile = { gold:0, exp:0 };
        local.updated_at = nowIso();
        saveLocal(local);
      }
    }

    /* ======= ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼ˆæ—¢å­˜saveã‚’ãƒ©ãƒƒãƒ—ï¼‰ ======= */
    function _saveLocalOnly(){
      const local = loadLocal();
      localStorage.setItem(LS_Q, JSON.stringify(local.quests));
      localStorage.setItem(LS_P, JSON.stringify(local.profile));
    }
    // æ—¢å­˜ã‚¢ãƒ—ãƒªã« save() ãŒã‚ã‚‹å‰æã®ãƒ©ãƒƒãƒ—ï¼ˆãªã‘ã‚Œã°ã“ã®é–¢æ•°ã‚’ç›´æ¥å‘¼ã¶ï¼‰
    window.save = function(){
      _saveLocalOnly();
      localStorage.setItem('rpg-updated-at', nowIso());
      pushToCloudAuth(); // èªè¨¼æ¸ˆã¿ãªã‚‰ã‚¯ãƒ©ã‚¦ãƒ‰ã¸
    };

    /* ======= èªè¨¼ UI ======= */
    E.signinBtn.addEventListener('click', async () => {
      const email = prompt('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆMagic Linkã‚’é€ã‚Šã¾ã™ï¼‰');
      if(!email) return;
      const { error } = await supabase.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: location.href }
      });
      if(error) alert('é€ä¿¡å¤±æ•—: ' + error.message);
      else alert('ãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
    });
    E.signoutBtn.addEventListener('click', async () => {
      await supabase.auth.signOut();
      alert('ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
    });

    supabase.auth.onAuthStateChange(async (_event, session) => {
      const user = session?.user || null;
      E.signinBtn.style.display  = user ? 'none' : 'inline-block';
      E.signoutBtn.style.display = user ? 'inline-block' : 'none';
      E.authState.textContent = user ? `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${user.email||user.id}` : 'æœªãƒ­ã‚°ã‚¤ãƒ³';
      E.rlsHint.style.display = user ? 'block' : 'none';
      if(user){
        // è‡ªåˆ†ã®è¡ŒãŒç„¡ã‘ã‚Œã°ä½œæˆï¼ˆåˆå›ï¼‰
        const { data } = await supabase.from('profiles').select('user_id').eq('user_id', user.id).maybeSingle();
        if(!data){
          const local = loadLocal();
          await supabase.from('profiles').insert({
            user_id: user.id,
            payload: { quests: local.quests, profile: local.profile }
          });
        }
        await pullFromCloudAuth();
      }
    });

    /* ======= ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ ======= */
    async function pullFromCloudAuth(){
      const { data, error } = await supabase
        .from('profiles').select('*')
        .eq('user_id', (await supabase.auth.getUser()).data.user.id)
        .maybeSingle();
      if(error){ console.warn('pull error', error); E.syncState.textContent='ã‚ªãƒ•ãƒ©ã‚¤ãƒ³'; return; }
      if(!data){ E.syncState.textContent='ã‚¯ãƒ©ã‚¦ãƒ‰æœªä½œæˆ'; return; }
      const local = loadLocal();
      if(!local.updated_at || new Date(data.updated_at) > new Date(local.updated_at)){
        saveLocal({ quests: data.payload.quests||[], profile: data.payload.profile||{}, updated_at: data.updated_at });
        render();
      }
      E.syncState.textContent='åŒæœŸæ¸ˆã¿ï¼ˆpullï¼‰';
    }
    async function pushToCloudAuth(){
      const user = (await supabase.auth.getUser()).data.user;
      if(!user){ E.syncState.textContent='æœªãƒ­ã‚°ã‚¤ãƒ³ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã®ã¿ï¼‰'; return; }
      const local = loadLocal();
      const payload = { quests: local.quests, profile: local.profile };
      const { error } = await supabase
        .from('profiles')
        .upsert({ user_id: user.id, payload, updated_at: nowIso() });
      if(error){ console.warn('push error', error); E.syncState.textContent='ã‚ªãƒ•ãƒ©ã‚¤ãƒ³'; return; }
      E.syncState.textContent='åŒæœŸæ¸ˆã¿ï¼ˆpushï¼‰';
    }

    /* ======= UIã‚¤ãƒ™ãƒ³ãƒˆ ======= */
    document.addEventListener('click', (e)=>{
      const t = e.target;
      const act = t.getAttribute('data-act');
      const id = t.getAttribute('data-id');
      if(act==='done' && id){
        const local = loadLocal();
        const q = local.quests.find(x=> x.id===id);
        if(!q) return;
        q.timesCompleted = (q.timesCompleted||0)+1;
        local.profile.gold = (local.profile.gold||0) + (q.gold||0);
        local.profile.exp = (local.profile.exp||0) + (q.exp||0);
        local.updated_at = nowIso();
        saveLocal(local);
        render();
        pushToCloudAuth();
      }
    });
    E.addBtn.addEventListener('click', ()=>{
      const title = (E.newTitle.value||'').trim();
      if(!title) return;
      const local = loadLocal();
      local.quests.unshift({ id: uid(), title, exp:50, gold:20, repeatable:true, timesCompleted:0 });
      local.updated_at = nowIso();
      saveLocal(local);
      E.newTitle.value = '';
      render();
      pushToCloudAuth();
    });
    E.resetBtn.addEventListener('click', ()=>{
      if(!confirm('ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ')) return;
      localStorage.removeItem(LS_Q);
      localStorage.removeItem(LS_P);
      localStorage.removeItem('rpg-updated-at');
      ensureSeed();
      render();
      pushToCloudAuth();
    });
    E.exportBtn.addEventListener('click', ()=>{
      const local = loadLocal();
      const blob = new Blob([JSON.stringify(local, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'quest-board-export.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });
    E.importBtn.addEventListener('click', ()=> E.importFile.click());
    E.importFile.addEventListener('change', async ()=>{
      const file = E.importFile.files[0];
      if(!file) return;
      const text = await file.text();
      const obj = JSON.parse(text);
      saveLocal({ quests: obj.quests||[], profile: obj.profile||{}, updated_at: obj.updated_at||nowIso() });
      render();
      pushToCloudAuth();
      E.importFile.value='';
    });

    /* ======= èµ·å‹• ======= */
    ensureSeed();
    render();
    // æœªãƒ­ã‚°ã‚¤ãƒ³æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿è¡¨ç¤ºï¼ˆãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨onAuthStateChangeã§pullï¼‰
  </script>
</body>
</html>
