<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>RPG Quest Board — ver.08 + Supabase Sync</title>

  <!-- PWA hooks (optional, keep as-is if you already use manifest/sw) -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#3b2908">
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
      });
    }
  </script>

  <style>
    :root{
      --bg1:#7a4a0c; --bg2:#3b2908; --ink:#f9f4e8; --border:rgba(248,235,197,.25);
      --paper:#f4e4c1; --paper-ink:#2f2616; --midpaper:#e9d9b5; --searchbg: rgba(255,255,255,.06);
      --muted:#cbb98f; --expText:#cbb98f; --board-dark:#3b2a12; --page-bg:linear-gradient(135deg,var(--bg1),var(--bg2));
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--page-bg);color:var(--ink);
         font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans JP',sans-serif}
    header{position:sticky;top:0;background:rgba(35,26,9,.75);backdrop-filter:blur(6px);
           border-bottom:1px solid var(--border);z-index:40}
    .wrap{max-width:1120px;margin:0 auto;padding:10px 14px;display:flex;align-items:center;gap:10px}
    h1{font-size:18px;margin:0;font-weight:800;letter-spacing:.3px}
    .btn{appearance:none;border:1px solid var(--border);background:var(--searchbg);color:var(--ink);
         padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{background:rgba(255,255,255,.12)}
    .btn.small{padding:6px 10px;font-size:12px;border-radius:9px}
    .btn.danger{background:#9a1f1f;border-color:#7f1717}
    .btn.danger:hover{background:#b32626}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .sp{flex:1}
    main{max-width:1120px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:980px){.grid{grid-template-columns:1fr 2fr}}
    .card{background:rgba(0,0,0,.18);border:1px solid var(--border);border-radius:16px;overflow:hidden}
    .card h2{margin:0;padding:12px 14px;border-bottom:1px solid var(--border);font-size:15px}
    .content{padding:12px 14px}
    input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--searchbg);color:var(--ink)}
    select option{ color:#000; background:#fff; }
    textarea{min-height:72px;resize:vertical}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px}
    .b-exptext{background:var(--searchbg);color:var(--expText)}
    .muted{color:var(--muted)}
    .progress{height:8px;background:rgba(255,255,255,.12);border-radius:999px;overflow:hidden}
    .progress>i{display:block;height:100%;background:linear-gradient(90deg,#e9b161,#e9d861)}
    .tabs{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
    .tab{padding:6px 8px;text-align:center;border:1px solid var(--border);border-radius:999px;background:var(--searchbg);cursor:pointer;font-size:12px}
    .tab.active{background:rgba(255,255,255,.16)}
    .search{position:relative}
    .search input{padding-left:30px}
    .search:before{content:'🔎';position:absolute;left:8px;top:50%;transform:translateY(-50%);opacity:.7}
    .list{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:620px){.list{grid-template-columns:1fr 1fr}}
    .quest{background:var(--paper);color:var(--paper-ink);border:1px solid #e5d7ae;border-radius:12px;padding:10px;position:relative;box-shadow:0 8px 18px rgba(0,0,0,.18)}
    .quest h3{margin:0 0 6px 0;font-size:15px;color:#2a1f0e}
    .desc{color:#443418}
    .unlocks{color:#5a4828;font-size:13px;margin-top:4px}
    .box{background:#dbcaa6;border:1px solid var(--border);border-radius:10px;padding:6px 10px;display:inline-flex;align-items:center;gap:6px}
    .quest .lock{position:absolute;top:8px;right:8px;background:var(--searchbg);border:1px solid var(--border);border-radius:10px;padding:4px 8px;font-size:12px;display:none}
    .quest.edit .lock{display:inline-block}
    .quest .editBar{position:absolute;left:8px;bottom:8px;display:none;gap:8px}
    .quest.edit .editBar{display:flex}
    .quest .delBtn{position:absolute;right:8px;bottom:8px;display:none}
    .quest.edit .delBtn{display:inline-block}
    .drawer{position:fixed;inset:0;display:none;z-index:50}
    .drawer.open{display:block}
    .drawer .panel{position:absolute;inset:0 35% 0 0;background:#1c1407;border-right:1px solid var(--border);overflow:auto}
    @media(max-width:980px){.drawer .panel{inset:0;max-width:460px}}
    .drawer .shade{position:absolute;inset:0;background:rgba(0,0,0,.35)}

    /* Sync panel */
    #syncFloat{position:fixed;right:12px;bottom:12px;z-index:9999;
      background:rgba(0,0,0,.55);backdrop-filter:blur(6px);
      color:#fff;border:1px solid rgba(255,255,255,.15);border-radius:12px;
      padding:8px 10px;display:flex;gap:8px;align-items:center;font:12px/1.3 system-ui,sans-serif}
    #syncFloat button{appearance:none;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.06);
      color:#fff;border-radius:8px;padding:6px 8px;cursor:pointer}
    #syncFloat button:hover{background:rgba(255,255,255,.12)}
    #syncFloat .dot{width:8px;height:8px;border-radius:50%;background:#aaa}
    #syncFloat .dot.on{background:#54d38a}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <button id="adminBtn" class="btn">☰</button>
      <h1>RPG Quest Board</h1>
      <div class="sp"></div>
      <button id="toggleEdit" class="btn">編集モード: OFF</button>
      <button id="resetBtn" class="btn">初期化</button>
    </div>
  </header>

  <!-- Admin Drawer -->
  <div id="adminDrawer" class="drawer">
    <div class="shade" data-close></div>
    <div class="panel">
      <div class="wrap" style="padding:10px;border-bottom:1px solid var(--border)">
        <div style="font-weight:600">運営モード</div>
        <div class="sp"></div>
        <button class="btn" data-close>閉じる</button>
      </div>
      <div style="padding:12px" class="col">
        <div class="card">
          <h2>クエスト追加</h2>
          <div class="content col">
            <input id="qTitle" placeholder="タイトル（例: 本を30分読む）">
            <textarea id="qDesc" placeholder="説明（任意）"></textarea>
            <div class="row">
              <input type="number" id="qExp" placeholder="XP" value="50" style="max-width:120px">
              <input type="number" id="qGold" placeholder="Gold" value="20" style="max-width:120px">
              <select id="qDiff" style="max-width:140px">
                <option value="EASY">EASY</option>
                <option value="NORMAL" selected>NORMAL</option>
                <option value="HARD">HARD</option>
              </select>
              <select id="qRuleType" style="max-width:200px">
                <option value="NONE" selected>ルールなし</option>
                <option value="STAT_UP">ステータス上昇</option>
                <option value="UNLOCK_SKILL">スキル開放</option>
                <option value="UNLOCK_JOB">職業開放</option>
              </select>
            </div>
            <div class="row">
              <input id="qRuleTarget" placeholder="対象（例: 筋力+1 / スキル名 / 職業名）">
              <input type="number" id="qRuleCount" placeholder="必要クリア回数" style="max-width:160px" value="1">
              <label class="row" style="gap:6px"><input type="checkbox" id="qHideCond"> 解放条件を隠す</label>
            </div>
            <div class="row">
              <button id="addQuestBtn" class="btn">追加</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <main>
    <div class="tabs" id="mainTabs">
      <div class="tab active" data-v="quests">クエスト</div>
      <div class="tab" data-v="status">ステータス</div>
    </div>

    <section id="pageQuests" class="grid" style="margin-top:12px">
      <div class="col">
        <div class="card">
          <h2>冒険者プロフィール</h2>
          <div class="content col">
            <div class="row">
              <span class="badge b-exptext">LV <b id="lv">1</b></span>
              <span class="muted">EXP <b id="expProg">0</b>/<b id="expNeed">100</b></span>
            </div>
            <div class="progress"><i id="expBar" style="width:0%"></i></div>
            <div class="row" style="margin-top:6px">
              <span class="badge b-exptext">💰 <b id="gold">0</b> Gold</span>
            </div>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="card">
          <h2>クエスト掲示板</h2>
          <div class="content col">
            <div class="row" style="flex-wrap:wrap; gap:8px">
              <div id="filters" class="tabs" style="grid-template-columns:repeat(3,1fr)">
                <div data-v="ACTIVE" class="tab active">進行中</div>
                <div data-v="ARCHIVED" class="tab">完了</div>
                <div data-v="ALL" class="tab">全部</div>
              </div>
              <div class="search" style="flex:1">
                <input id="search" placeholder="検索（タイトル・説明）">
              </div>
            </div>
            <div id="list" class="list" style="margin-top:8px"></div>
          </div>
        </div>
      </div>
    </section>

    <section id="pageStatus" style="display:none;margin-top:12px">
      <div class="card">
        <h2>ステータス</h2>
        <div class="content">
          <div class="row" style="margin-top:8px">
            <span class="badge b-exptext">LV <b id="lv2">1</b></span>
            <span class="muted">EXP <b id="expProg2">0</b>/<b id="expNeed2">100</b></span>
            <span class="badge b-exptext">💰 <b id="gold2">0</b> Gold</span>
          </div>
          <div class="progress" style="margin-top:4px"><i id="expBar2" style="width:0%"></i></div>
        </div>
      </div>
    </section>
  </main>

  <!-- Sync floating panel -->
  <div id="syncFloat">
    <span class="dot" id="syncDot"></span>
    <span id="syncText">未ログイン</span>
    <button id="sbSignIn">サインイン</button>
    <button id="sbSignOut" style="display:none">サインアウト</button>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    /* ===== Supabase settings ===== */
    const SUPABASE_URL = "https://jjyjcxswkcqtcxenytam.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqeWpjeHN3a2NxdGN4ZW55dGFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0MzYxMDEsImV4cCI6MjA3NDAxMjEwMX0.Hyp3MGsO8Aouyvctdx3QnQITPlqcLxkdeooBPhFYGEw";
    const REDIRECT_TO = "https://sekiruto.github.io/Quest-Board/";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{ persistSession:true, autoRefreshToken:true } });

    /* ===== Local Storage Keys (ver.08) ===== */
    const LS_Q='rpg-quest-todo-v8';
    const LS_P='rpg-quest-profile-v4';
    const LS_UPDATED='rpg-updated-at';

    /* ===== Default quests (your screenshot 6 items) ===== */
    const defaultQuests = [
      { id: uid(), title:"【読書[ビギナー]】知識の芽を育てよ", difficulty:"EASY", gold:20, exp:30, description:"25分読書する。", timesCompleted:0, archived:false, locked:false, rule:{type:"NONE"}, hideCondition:false },
      { id: uid(), title:"【読書[ノービス]】小さな書庫を開け", difficulty:"EASY", gold:30, exp:40, description:"読書を36分する\n解放条件: 7回でステータス+1", timesCompleted:0, archived:false, locked:false, rule:{type:"STAT_UP", target:"ステータス+1", count:7}, hideCondition:false },
      { id: uid(), title:"【瞑想[ビギナー]】静寂の扉をノックせよ", difficulty:"EASY", gold:5, exp:10, description:"瞑想を10分する", timesCompleted:0, archived:false, locked:false, rule:{type:"NONE"}, hideCondition:false },
      { id: uid(), title:"【瞑想[ノービス]】心の湖に石を投じよ", difficulty:"EASY", gold:20, exp:30, description:"瞑想を40分する\n解放条件: 7回でステータス+1", timesCompleted:0, archived:false, locked:false, rule:{type:"STAT_UP", target:"ステータス+1", count:7}, hideCondition:false },
      { id: uid(), title:"【歩行[ビギナー]】石畳を10歩進め", difficulty:"EASY", gold:15, exp:30, description:"20分間ウォーキングする", timesCompleted:0, archived:false, locked:false, rule:{type:"NONE"}, hideCondition:false },
      { id: uid(), title:"【歩行[ノービス]】朝霧の小道を往け", difficulty:"NORMAL", gold:25, exp:40, description:"30分間ウォーキングする\n解放条件: 5回でステータス+1", timesCompleted:0, archived:false, locked:false, rule:{type:"STAT_UP", target:"ステータス+1", count:5}, hideCondition:false },
    ];

    /* ===== State / Utils ===== */
    let editMode=false, filter='ACTIVE', searchText='';
    const $ = (id)=>document.getElementById(id);
    function nowIso(){ return new Date().toISOString(); }
    function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
    function levelFromExp(exp){ let lvl=1, need=100, left=exp; while(left>=need){ left-=need; lvl++; need+=50; } return {level:lvl,toNext:need,progress:left}; }
    function loadLocal(){
      return {
        quests: JSON.parse(localStorage.getItem(LS_Q)||'[]'),
        profile: JSON.parse(localStorage.getItem(LS_P)||'{"gold":0,"exp":0}'),
        updated_at: localStorage.getItem(LS_UPDATED) || null
      };
    }
    function saveLocal(data){
      localStorage.setItem(LS_Q, JSON.stringify(data.quests));
      localStorage.setItem(LS_P, JSON.stringify(data.profile));
      localStorage.setItem(LS_UPDATED, data.updated_at || nowIso());
    }

    /* ===== Rendering (ver.08風の最低限) ===== */
    function renderProfile(){
      const local = loadLocal();
      const lv = levelFromExp(local.profile.exp||0);
      $('lv').textContent = lv.level;
      $('expProg').textContent = lv.progress;
      $('expNeed').textContent = lv.toNext;
      $('expBar').style.width = (lv.progress/lv.toNext*100)+'%';
      $('gold').textContent = local.profile.gold||0;

      $('lv2').textContent = lv.level;
      $('expProg2').textContent = lv.progress;
      $('expNeed2').textContent = lv.toNext;
      $('expBar2').style.width = (lv.progress/lv.toNext*100)+'%';
      $('gold2').textContent = local.profile.gold||0;
    }
    function questMatches(q){
      if(filter==='ACTIVE' && q.archived) return false;
      if(filter==='ARCHIVED' && !q.archived) return false;
      if(!searchText) return true;
      const s=(q.title+' '+(q.description||'')).toLowerCase();
      return s.includes(searchText.toLowerCase());
    }
    function ruleText(q){
      if(q.hideCondition) return '（隠し条件）';
      const r=q.rule||{type:'NONE'};
      if(!r || r.type==='NONE') return '';
      const n=r.count?`（${r.count}回）`:'';
      if(r.type==='STAT_UP') return `条件${n}でステータス上昇：${r.target||''}`;
      if(r.type==='UNLOCK_SKILL') return `条件${n}でスキル開放：${r.target||''}`;
      if(r.type==='UNLOCK_JOB') return `条件${n}で職業開放：${r.target||''}`;
      return '';
    }
    function questCardHTML(q){
      return `
      <div class="quest ${editMode?'edit':''}" data-id="${q.id}">
        <button class="lock" data-act="toggleLock" title="${q.locked?'ロック解除':'ロック'}">🔒 ${q.locked?'LOCKED':'LOCK'}</button>
        <h3><span class="box">${q.title}</span></h3>
        ${q.description?`<div class="desc">${q.description.replace(/\\n/g,'<br>')}</div>`:''}
        ${ruleText(q)?`<div class="unlocks">${ruleText(q)}</div>`:''}
        <div class="row" style="margin-top:8px;align-items:center">
          <span class="box"><button class="btn small" data-act="done">達成報告</button></span>
          <div class="sp"></div>
          <span class="muted">${q.difficulty||'NORMAL'}</span>
          <span class="muted">🔥 ${q.gold||0}G</span>
          <span class="muted">${q.exp||0}EXP</span>
          <span class="muted">反復 ×${q.timesCompleted||0}</span>
        </div>
        <div class="editBar">
          <button class="btn small" data-act="edit">編集</button>
          <button class="btn small" data-act="archive">${q.archived?'再開':'完了へ'}</button>
        </div>
        <button class="btn small danger delBtn" data-act="delete">削除</button>
      </div>`;
    }
    function renderBoard(){
      const local = loadLocal();
      const arr = (local.quests||[]).filter(questMatches);
      $('list').innerHTML = arr.map(questCardHTML).join('');
    }
    function render(){ renderProfile(); renderBoard(); }

    /* ===== Save wrapper (ver.08 の save() をクラウド連携に) ===== */
    (function wrapSave(){
      const orig = window.save;
      window.save = function(){
        if(typeof orig === 'function') orig();
        localStorage.setItem(LS_UPDATED, nowIso());
        pushToCloudAuth();
      };
    })();

    /* ===== Supabase Sync ===== */
    const dot=$('syncDot'), txt=$('syncText'), btnIn=$('sbSignIn'), btnOut=$('sbSignOut');
    function setState(message, online=false){ txt.textContent=message; dot.classList.toggle('on',!!online); }

    async function ensureProfileRow(user){
      const { data, error } = await supabase.from('profiles').select('*').eq('user_id', user.id).maybeSingle();
      if(error){ console.warn(error); return null; }
      if(!data){
        // 初回：デフォルトクエストで作成（クラウド優先）
        const payload = { quests: defaultQuests, profile:{ gold:0, exp:0 } };
        const { error:insErr } = await supabase.from('profiles').insert({ user_id:user.id, payload, updated_at: nowIso() });
        if(insErr) console.warn(insErr);
        // ローカルも同じにする
        saveLocal({ quests: payload.quests, profile: payload.profile, updated_at: nowIso() });
        return payload;
      }
      return data;
    }

    async function pullFromCloudAuth(forceCloud=true){
      const u = (await supabase.auth.getUser()).data.user;
      if(!u){ setState('未ログイン', false); return; }
      setState('クラウド取得中…', true);
      const row = await ensureProfileRow(u);
      if(!row){ setState('同期不可', false); return; }

      const payload = row.payload ? row.payload : row;
      const cloudUpdated = row.updated_at || nowIso();

      const local = loadLocal();
      const cloudIsNewer = !local.updated_at || forceCloud || new Date(cloudUpdated) > new Date(local.updated_at||'1970-01-01T00:00:00.000Z');

      if(cloudIsNewer){
        saveLocal({ quests: payload.quests||[], profile: payload.profile||{gold:0,exp:0}, updated_at: cloudUpdated });
        render();
        setState('同期済み（pull）', true);
      }else{
        setState('最新（local）', true);
      }
    }

    async function pushToCloudAuth(){
      const u = (await supabase.auth.getUser()).data.user;
      if(!u){ setState('未ログイン（ローカル保存）', false); return; }
      const local = loadLocal();
      const { error } = await supabase.from('profiles').upsert({ user_id:u.id, payload:{ quests: local.quests, profile: local.profile }, updated_at: nowIso() });
      if(error){ console.warn('push error', error); setState('オフライン', false); return; }
      setState('同期済み（push）', true);
    }

    /* ===== Events ===== */
    // Tabs
    $('mainTabs').addEventListener('click', (e)=>{
      const t = e.target.closest('.tab'); if(!t) return;
      document.querySelectorAll('#mainTabs .tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const v=t.dataset.v;
      $('pageQuests').style.display = (v==='quests')?'grid':'none';
      $('pageStatus').style.display = (v==='status')?'block':'none';
    });
    // Filters
    $('filters').addEventListener('click', (e)=>{
      const t = e.target.closest('.tab'); if(!t) return;
      document.querySelectorAll('#filters .tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active'); filter = t.dataset.v; renderBoard();
    });
    // Search
    $('search').addEventListener('input', (e)=>{ searchText = e.target.value; renderBoard(); });

    // Admin drawer
    const drawer=$('adminDrawer');
    $('adminBtn').addEventListener('click', ()=> drawer.classList.add('open'));
    drawer.addEventListener('click', (e)=>{ if(e.target.matches('[data-close]')) drawer.classList.remove('open'); });

    // Add quest
    $('addQuestBtn').addEventListener('click', ()=>{
      const title = $('qTitle').value.trim(); if(!title) return;
      const desc = $('qDesc').value.trim();
      const exp = parseInt(($('qExp').value||'0'),10);
      const gold = parseInt(($('qGold').value||'0'),10);
      const diff = $('qDiff').value;
      const type = $('qRuleType').value;
      const target = $('qRuleTarget').value.trim();
      const count = parseInt(($('qRuleCount').value||'1'),10);
      const hideCondition = $('qHideCond').checked;

      const local = loadLocal();
      local.quests.unshift({
        id: uid(), title, description:desc, exp, gold, difficulty:diff,
        timesCompleted:0, archived:false, locked:false,
        rule:{type, target, count}, hideCondition
      });
      saveLocal({ quests: local.quests, profile: local.profile, updated_at: nowIso() });
      render();
      pushToCloudAuth();

      // clear
      $('qTitle').value=''; $('qDesc').value=''; $('qExp').value='50'; $('qGold').value='20';
      $('qRuleTarget').value=''; $('qRuleCount').value='1'; $('qHideCond').checked=false;
    });

    // Edit mode toggle
    $('toggleEdit').addEventListener('click', ()=>{
      editMode = !editMode;
      $('toggleEdit').textContent = '編集モード: ' + (editMode?'ON':'OFF');
      renderBoard();
    });

    // Quest actions
    document.addEventListener('click', (e)=>{
      const card = e.target.closest('.quest'); if(!card) return;
      const id = card.dataset.id;
      const act = e.target.getAttribute('data-act');
      if(!act) return;

      const local = loadLocal();
      const q = local.quests.find(x=>x.id===id); if(!q) return;

      if(act==='done'){
        q.timesCompleted = (q.timesCompleted||0)+1;
        local.profile.gold = (local.profile.gold||0) + (q.gold||0);
        local.profile.exp = (local.profile.exp||0) + (q.exp||0);
      }
      if(act==='edit' && editMode){
        if(q.locked){ alert('ロック中のため編集できません'); return; }
        const t = prompt('タイトル', q.title); if(t===null) return;
        const d = prompt('説明', q.description||''); if(d===null) return;
        q.title = t; q.description = d;
      }
      if(act==='archive' && editMode){
        if(q.locked){ alert('ロック中のため変更できません'); return; }
        q.archived = !q.archived;
      }
      if(act==='delete' && editMode){
        if(q.locked){ alert('ロック中のため削除できません'); return; }
        local.quests = local.quests.filter(x=> x.id!==id);
      }
      if(act==='toggleLock' && editMode){
        q.locked = !q.locked;
      }

      saveLocal({ quests: local.quests, profile: local.profile, updated_at: nowIso() });
      render();
      pushToCloudAuth();
    });

    // Reset
    $('resetBtn').addEventListener('click', ()=>{
      if(!confirm('初期化しますか？（ローカル＆クラウド）')) return;
      saveLocal({ quests: [], profile:{gold:0,exp:0}, updated_at: nowIso() });
      render();
      pushToCloudAuth();
    });

    /* ===== Auth UI ===== */
    $('sbSignIn').addEventListener('click', async ()=>{
      const email = prompt('メールアドレスを入力してください（Magic Linkを送ります）'); if(!email) return;
      const { error } = await supabase.auth.signInWithOtp({ email, options:{ emailRedirectTo: REDIRECT_TO, shouldCreateUser:true }});
      if(error) alert('送信失敗: '+error.message); else alert('メールを確認してください');
    });
    $('sbSignOut').addEventListener('click', async ()=>{ await supabase.auth.signOut(); setState('未ログイン', false); });

    supabase.auth.onAuthStateChange(async (_e, session)=>{
      const user = session?.user || null;
      $('sbSignIn').style.display = user ? 'none' : 'inline-block';
      $('sbSignOut').style.display = user ? 'inline-block' : 'none';
      setState(user ? `ログイン中: ${user.email||user.id}` : '未ログイン', !!user);
      if(user){
        await pullFromCloudAuth(true); // ログイン直後はクラウド優先
      }
    });

    /* ===== Boot ===== */
    (function seedIfEmpty(){
      const local = loadLocal();
      if(!local.quests || local.quests.length===0){
        saveLocal({ quests: defaultQuests, profile:{gold:0,exp:0}, updated_at: nowIso() });
      }
    })();
    render();

  </script>
</body>
</html>
