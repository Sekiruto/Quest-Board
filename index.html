<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>RPG Quest Board — Tavern (Lock top-right, Edit bottom-left, Delete bottom-right)</title>
<style>
  :root{
    --bg1:#7a4a0c; --bg2:#3b2908; --panel:#2a1f0e; --ink:#f9f4e8;
    --muted:#cbb98f;
    --border:rgba(248,235,197,.25);
    --paper:#f4e4c1; --paper-ink:#2f2616;
    --accent:#9b6b21; --accent-2:#e2ad40; --green:#2da36a; --amber:#fbbf24; --indigo:#6366f1;
    --searchbg: rgba(255,255,255,.06);
    --midpaper:#e9d9b5;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:var(--ink);
       font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans JP',sans-serif}
  header{position:sticky;top:0;background:rgba(35,26,9,.75);backdrop-filter:blur(3px);z-index:2}
  nav{display:flex;align-items:center;padding:8px 12px;max-width:800px;margin:0 auto;gap:12px;height:48px}
  nav > .logo{font-weight:700;font-size:18px;letter-spacing:-.03em;text-shadow:0 0 1px var(--ink)}
  nav > .fill{flex:1}
  .btn{appearance:none;border:none;background:var(--accent);color:var(--ink);
       font:inherit;font-weight:700;padding:4px 12px;cursor:pointer;
       border-radius:4px;box-shadow:0 0 0 1px var(--border) inset, 0 1px 0 rgba(0,0,0,.25);
       text-shadow:0 1px 0 rgba(0,0,0,.15);height:32px;white-space:nowrap}
  .btn:hover{background:var(--accent-2);box-shadow:0 0 0 1px var(--border) inset, 0 1px 2px rgba(0,0,0,.25)}
  .btn:active{transform:translateY(1px);box-shadow:0 0 0 1px var(--border) inset}
  .btn.ghost{background:transparent;box-shadow:none;text-shadow:none;color:var(--muted)}
  .btn.ghost:hover{color:var(--ink);background:rgba(255,255,255,.05);box-shadow:none}
  .btn.ghost:active{transform:none}
  .btn.reset{background:#c05040;color:var(--ink)}
  main{max-width:800px;margin:0 auto}
  .quest-board{padding:12px 0}
  .quest-list{display:flex;flex-direction:column;gap:8px}
  .quest-card{
    display:grid; grid-template-rows: auto 1fr auto;
    background:var(--paper); color:var(--paper-ink);
    padding:16px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,.1);
    position:relative; overflow:hidden;
  }
  .quest-card::before{
    content:''; position:absolute; top:0;left:0; right:0; bottom:0;
    background:linear-gradient(135deg, rgba(255,255,255,.7) 0%, rgba(255,255,255,0) 25%);
    opacity:.5;
    transform:skewX(-25deg) translateX(-100%);
    transition:transform .5s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .quest-card:hover::before{ transform:skewX(-25deg) translateX(100%); }
  .quest-card.archived{
    filter:grayscale(100%); opacity:.6;
    background:var(--midpaper);
  }
  .quest-card.archived::before{ display:none; }
  .quest-card.locked{
    filter:grayscale(100%); opacity:.5;
    background:var(--midpaper);
    pointer-events: none;
  }
  .quest-card.locked > *{opacity:.5}
  .quest-header{display:flex;align-items:center;gap:8px;position:relative}
  .quest-header .title{font-weight:700;font-size:18px;flex:1}
  .quest-header .reward{font-size:12px;white-space:nowrap;display:flex;gap:4px;align-items:center}
  .quest-meta{display:flex;gap:4px;font-size:12px;color:var(--muted);justify-content:flex-end}
  .quest-body{
    line-height:1.6; margin:8px 0; font-size:15px;
    border:1px dashed var(--border); padding:8px; border-radius:4px;
    background:rgba(0,0,0,.03);
  }
  .quest-body p:first-child{margin-top:0}
  .quest-body p:last-child{margin-bottom:0}
  .quest-footer{display:flex;gap:8px;justify-content:flex-end;position:relative}
  .quest-footer .lock-btn{position:absolute;top:4px;left:4px;width:24px;height:24px;
                        background:var(--ink); border-radius:50%; display:grid; place-items:center}
  .quest-footer .lock-btn svg{width:16px;height:16px}
  .quest-footer .edit-btn{position:absolute;top:4px;left:4px;width:24px;height:24px;
                        background:var(--ink); border-radius:50%; display:grid; place-items:center}
  .quest-footer .edit-btn svg{width:16px;height:16px}
  .quest-footer .delete-btn{position:absolute;top:4px;right:4px;width:24px;height:24px;
                          background:var(--ink); border-radius:50%; display:grid; place-items:center}
  .quest-footer .delete-btn svg{width:16px;height:16px}
  .profile-panel{
    display:flex; flex-direction:column;gap:16px;
    background:var(--panel); color:var(--ink);
    padding:16px; border-radius:8px;
    box-shadow:0 2px 4px rgba(0,0,0,.1);
    margin:12px;
  }
  .profile-panel h2{font-weight:700;font-size:18px;margin:0 0 8px 0}
  .profile-stats{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
  .profile-stats > div{
    display:flex; flex-direction:column; align-items:center;
    background:var(--bg2); padding:8px 12px; border-radius:4px;
    box-shadow:0 1px 0 rgba(0,0,0,.1); min-width:60px
  }
  .profile-stats .val{font-size:24px;font-weight:700;color:var(--accent-2)}
  .profile-stats .label{font-size:12px;color:var(--muted)}
  .profile-meter{display:flex;align-items:center;gap:8px}
  .profile-meter .label{font-size:14px;white-space:nowrap}
  .profile-meter .bar{
    flex:1;height:8px;background:var(--bg2);border-radius:4px;
    position:relative;overflow:hidden;
  }
  .profile-meter .bar::before{
    content:''; position:absolute; top:0;left:0;bottom:0;
    background:var(--green); transition:width .25s ease-out
  }
  .profile-meter .label.exp{font-size:12px}
  .add-quest-panel{
    padding:16px; background:var(--panel);
    border-radius:8px; margin:12px;
    display:flex; flex-direction:column; gap:12px;
  }
  .add-quest-panel h3{margin:0;font-weight:700;font-size:16px}
  .add-quest-panel .input-group{display:flex;flex-direction:column;gap:4px}
  .add-quest-panel label{font-size:14px;color:var(--muted)}
  .add-quest-panel input, .add-quest-panel textarea{
    appearance:none; border:none; background:rgba(0,0,0,.1);
    color:var(--ink); font:inherit; padding:8px;
    border-radius:4px; box-shadow:0 0 0 1px var(--border) inset;
  }
  .add-quest-panel .quest-type{display:flex;gap:8px}
  .add-quest-panel .quest-type input{flex:1}
  .add-quest-panel .quest-type input[type="radio"]{
    display:none;
  }
  .add-quest-panel .quest-type label{
    display:block; flex:1; padding:8px 12px;
    background:rgba(0,0,0,.1); border-radius:4px;
    text-align:center; cursor:pointer;
    box-shadow:0 0 0 1px var(--border) inset;
  }
  .add-quest-panel .quest-type input[type="radio"]:checked + label{
    background:var(--accent-2); color:var(--paper-ink);
  }
  .add-quest-panel .reward-inputs{
    display:flex; flex-direction:column; gap:8px;
  }
  .add-quest-panel .reward-inputs > div{display:flex;gap:8px;align-items:center}
  .add-quest-panel .reward-inputs input{flex:1}
  .add-quest-panel .reward-inputs label{white-space:nowrap}

  #admin-drawer{
    position:fixed; top:0; left:0; width:100%; height:100%; z-index:100;
    display:flex; visibility:hidden; opacity:0;
    transition:opacity .2s ease-in-out, visibility .2s ease-in-out;
  }
  #admin-drawer.open{visibility:visible;opacity:1}
  #admin-drawer .shade{
    position:absolute; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,.75);
  }
  #admin-drawer .drawer{
    background:var(--bg2); padding:16px; max-width:400px;
    margin-left:auto; z-index:1;
    display:flex; flex-direction:column; gap:16px;
    transform:translateX(100%); transition:transform .3s ease-in-out;
    box-shadow:-2px 0 4px rgba(0,0,0,.2);
    width:calc(100% - 32px);
  }
  #admin-drawer.open .drawer{transform:translateX(0)}
  .drawer .drawer-header{
    display:flex;align-items:center;gap:8px;
  }
  .drawer .drawer-header .title{flex:1;font-size:18px;font-weight:700;margin:0}
  .drawer .drawer-header .close-btn{
    width:32px; height:32px; border-radius:50%;
    background:var(--accent-2); color:var(--paper-ink);
    display:grid; place-items:center; cursor:pointer;
  }
  .drawer .drawer-header .close-btn:hover{filter:brightness(1.1)}
  .drawer .drawer-header .close-btn:active{transform:scale(.95)}
  .drawer .drawer-header .close-btn svg{width:20px;height:20px}
</style>
</head>
<body>

<header>
  <nav>
    <div class="logo">RPG Quest Board</div>
    <div class="fill"></div>
    <div id="stats"></div>
    <button id="adminBtn" class="btn ghost">Admin</button>
  </nav>
</header>

<main>
  <div id="questBoard" class="quest-board"></div>
</main>

<div id="admin-drawer">
  <div id="shade" class="shade"></div>
  <div id="drawerPanel" class="drawer" tabindex="-1">
    <div class="drawer-header">
      <h2 class="title">Admin Panel</h2>
      <button id="closeDrawer" class="btn close-btn">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
        </svg>
      </button>
    </div>
    
    <div id="addQuestPanel" class="add-quest-panel">
      <h3>Add New Quest</h3>
      <div class="input-group">
        <label for="new-title">Title</label>
        <input type="text" id="new-title" placeholder="A simple task">
      </div>
      <div class="input-group">
        <label for="new-body">Description</label>
        <textarea id="new-body" placeholder="This is a simple quest."></textarea>
      </div>
      <div class="input-group">
        <label>Reward</label>
        <div class="reward-inputs">
          <div><label>Gold</label><input type="number" id="new-gold" value="0"></div>
          <div><label>Exp</label><input type="number" id="new-exp" value="0"></div>
        </div>
      </div>
      <div class="input-group">
        <label>Quest Type</label>
        <div class="quest-type">
          <input type="radio" id="type-single" name="new-type" value="single" checked><label for="type-single">Single</label>
          <input type="radio" id="type-repeatable" name="new-type" value="repeatable"><label for="type-repeatable">Repeatable</label>
        </div>
      </div>
      <button id="addQuestBtn" class="btn">Add Quest</button>
    </div>

    <div class="profile-panel">
      <h2>Profile</h2>
      <div id="profileStats" class="profile-stats"></div>
      <div id="expMeter" class="profile-meter"></div>
      <button id="initBtn" class="btn reset">Initialize Data</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/nanoid/nanoid.min.js"></script>
<script>
  // グローバル変数
  let quests = [];
  let profile = {};
  let pending = {}; // 削除・達成保留中のクエスト管理
  const LS_Q = "rpg_quests_local";
  const LS_P = "rpg_profile_local";

  // Nanoid
  const nanoid = window.nanoid;

  // ユーティリティ
  function getLS(key){
    try { return JSON.parse(localStorage.getItem(key) || "null"); } catch { return null; }
  }
  function setLS(key, val){
    try { localStorage.setItem(key, JSON.stringify(val)); } catch {}
  }
  function save(){
    setLS(LS_Q, quests);
    setLS(LS_P, profile);
    render();
  }
  function levelFromExp(exp) {
    const level = Math.floor(0.1 * Math.sqrt(exp)) + 1;
    const expForNext = Math.pow((level) / 0.1, 2);
    const expForPrev = Math.pow((level-1) / 0.1, 2);
    const progress = (exp - expForPrev) / (expForNext - expForPrev);
    return { level, expForNext, expForPrev, progress };
  }
  function applyUnlocksIfAny(quest, timesCompleted) {
    if (!quest.unlocks) return;
    quest.unlocks.forEach(unlock => {
      if (timesCompleted >= (unlock.threshold || 1)) {
        if (!profile.appliedUnlocks.some(a => a.questId === quest.id && a.unlockId === unlock.id)) {
          if (unlock.grant.type === 'stat') {
            const k = unlock.grant.key;
            profile.stats[k] = (profile.stats[k] || 0) + (unlock.grant.amount || 0);
          }
          if (unlock.grant.type === 'skill') {
            if (!profile.skills.some(s => s.key === unlock.grant.key)) {
              profile.skills.push({ key: unlock.grant.key, title: unlock.grant.title });
            }
          }
          if (unlock.grant.type === 'job') {
            if (!profile.jobs.some(j => j.key === unlock.grant.key)) {
              profile.jobs.push({ key: unlock.grant.key, title: unlock.grant.title });
            }
          }
          profile.appliedUnlocks.push({ questId: quest.id, unlockId: unlock.id });
        }
      }
    });
  }
  function grantLevelUpPoints(beforeLevel, afterLevel){
    const gained = afterLevel - beforeLevel;
    if(gained > 0) profile.skillPoints.unspent += gained;
    return gained;
  }
  function getSkillPoints(){
    let totalSpent = 0;
    for(const job in profile.skillPoints.perJob){
      totalSpent += profile.skillPoints.perJob[job];
    }
    return { unspent: profile.skillPoints.unspent, spent: totalSpent };
  }
  
  // UIレンダリング
  function render(){
    const questListEl = document.getElementById("questBoard");
    if (!questListEl) return;
    questListEl.innerHTML = quests.map(q => {
      const isArchived = q.archived;
      const isLocked = q.locked;
      const goldReward = q.reward?.gold || 0;
      const expReward = q.reward?.exp || 0;
      const rewards = [];
      if (goldReward > 0) rewards.push(`+${goldReward} Gold`);
      if (expReward > 0) rewards.push(`+${expReward} Exp`);

      return `
        <div class="quest-card ${isArchived ? 'archived' : ''} ${isLocked ? 'locked' : ''}" data-id="${q.id}">
          <div class="quest-header">
            <h3 class="title">${q.title}</h3>
            <div class="reward">${rewards.join(' ')}</div>
          </div>
          <div class="quest-body">${q.body}</div>
          <div class="quest-footer">
            <button class="btn" data-action="complete" data-id="${q.id}">Complete</button>
            <button class="btn ghost" data-action="edit" data-id="${q.id}">Edit</button>
            <button class="btn ghost" data-action="lock" data-id="${q.id}">Lock</button>
            <button class="btn ghost" data-action="delete" data-id="${q.id}">Delete</button>
          </div>
        </div>
      `;
    }).join('');

    const statsEl = document.getElementById("profileStats");
    if (statsEl && profile) {
      const expData = levelFromExp(profile.exp);
      const statsHtml = `
        <div><span class="val">${expData.level}</span><span class="label">Level</span></div>
        <div><span class="val">${profile.gold || 0}</span><span class="label">Gold</span></div>
        <div><span class="val">${getSkillPoints().unspent}</span><span class="label">SP</span></div>
      `;
      statsEl.innerHTML = statsHtml;
    }

    const expMeterEl = document.getElementById("expMeter");
    if (expMeterEl && profile) {
      const expData = levelFromExp(profile.exp);
      const expHtml = `
        <span class="label">EXP</span>
        <div class="bar">
          <div style="width:${expData.progress * 100}%"></div>
        </div>
        <span class="label exp">${profile.exp || 0} / ${expData.expForNext}</span>
      `;
      expMeterEl.innerHTML = expHtml;
    }
  }

  // クエスト操作
  function addQuest(q){
    const qData = Object.assign({}, q, {
      id: nanoid(),
      createdAt: Date.now(),
      locked: false,
      archived: false,
      timesCompleted: 0
    });
    quests.push(qData);
    save();
    alert("クエストを追加しました");
  }

  function completeQuestById(id){
    const q = quests.find(x => x.id === id);
    if (!q) {
      console.error("Quest not found locally:", id);
      return;
    }
    const before = levelFromExp(profile.exp).level;
    q.timesCompleted += 1;
    if (!q.repeatable) q.archived = true;
    profile.gold += (q.reward?.gold || 0);
    profile.exp  += (q.reward?.exp || 0);
    applyUnlocksIfAny(q, q.timesCompleted);
    const after  = levelFromExp(profile.exp).level;
    const gained = grantLevelUpPoints(before, after);
    save();
    if (gained > 0) setTimeout(() => alert('レベルアップ！スキルポイント +' + gained), 0);
  }

  function removeQuestById(id){
    quests = quests.filter(q => q.id !== id);
    save();
  }

  function toggleQuestLock(id){
    const q = quests.find(x => x.id === id);
    if (q) q.locked = !q.locked;
    save();
  }
  
  // 初期化・データ管理
  function initializeData(){
    const SEED = [
      { id:"seed-1", title:"看板を見る", body:"掲示板のクエストを確認する。", reward:{gold:50, exp:10}, repeatable:false, unlocks:[] },
      { id:"seed-2", title:"村人から話を聞く", body:"村の中心にいる人々と交流する。", reward:{gold:20, exp:25}, repeatable:true, unlocks:[] },
      { id:"seed-3", title:"鍛冶屋へ行く", body:"武器や防具が売られている。", reward:{gold:30, exp:30}, repeatable:true, unlocks:[] },
    ];
    quests = SEED.map((q,i)=> Object.assign({}, q, {order:i, createdAt: Date.now(), locked:false}));
    profile = { gold:0, exp:0, stats:{ hp:10, str:1, dex:1, int:1, vit:1 }, skills:[], jobs:[], appliedUnlocks:[], skillPoints:{unspent:2, perJob:{}}, lastLevel:1 };
    save();
    alert('ローカルデータが初期化されました。');
  }

  function loadLocalData(){
    const savedQuests = getLS(LS_Q);
    const savedProfile = getLS(LS_P);
    if (savedQuests && savedProfile) {
      quests = savedQuests;
      profile = savedProfile;
      console.log("ローカルデータを読み込みました。");
    } else {
      initializeData();
    }
    render();
  }

  // イベントリスナー
  document.addEventListener('DOMContentLoaded', () => {
    loadLocalData();

    document.getElementById('questBoard').addEventListener('click', (e) => {
      const target = e.target.closest('[data-action]');
      if (!target) return;
      const id = target.dataset.id;
      const action = target.dataset.action;
      
      if (action === 'complete') completeQuestById(id);
      if (action === 'delete') {
        if (confirm('このクエストを削除しますか？')) removeQuestById(id);
      }
      if (action === 'lock') toggleQuestLock(id);
      if (action === 'edit') {
        const q = quests.find(x => x.id === id);
        if (q) {
          document.getElementById('new-title').value = q.title;
          document.getElementById('new-body').value = q.body;
          document.getElementById('new-gold').value = q.reward?.gold || 0;
          document.getElementById('new-exp').value = q.reward?.exp || 0;
          document.getElementById('addQuestBtn').textContent = 'Update Quest';
          document.getElementById('addQuestBtn').dataset.updateId = id;
          document.getElementById('type-single').checked = !q.repeatable;
          document.getElementById('type-repeatable').checked = q.repeatable;
          openDrawer();
        }
      }
    });

    document.getElementById('addQuestBtn').addEventListener('click', () => {
      const title = document.getElementById('new-title').value;
      const body = document.getElementById('new-body').value;
      const gold = parseInt(document.getElementById('new-gold').value) || 0;
      const exp = parseInt(document.getElementById('new-exp').value) || 0;
      const repeatable = document.getElementById('type-repeatable').checked;
      const updateId = document.getElementById('addQuestBtn').dataset.updateId;

      if (!title || !body) {
        alert('タイトルと説明を入力してください。');
        return;
      }
      
      const questData = {
        title,
        body,
        reward: { gold, exp },
        repeatable
      };

      if (updateId) {
        const index = quests.findIndex(q => q.id === updateId);
        if (index > -1) {
          Object.assign(quests[index], questData, {
            lastUpdated: Date.now()
          });
          save();
          alert("クエストを更新しました");
          document.getElementById('addQuestBtn').textContent = 'Add Quest';
          delete document.getElementById('addQuestBtn').dataset.updateId;
        }
      } else {
        addQuest(questData);
      }
    });
    
    document.getElementById('initBtn').addEventListener('click', initializeData);
  });

  // 管理パネル
  const adminDrawerEl = document.getElementById('admin-drawer');
  function openDrawer(){ adminDrawerEl.classList.add('open'); }
  function closeDrawer(){ adminDrawerEl.classList.remove('open'); }
  document.getElementById('adminBtn').addEventListener('click', openDrawer);
  document.getElementById('closeDrawer').addEventListener('click', closeDrawer);
  document.getElementById('shade').addEventListener('click', closeDrawer);
  document.getElementById('drawerPanel').addEventListener('keydown', (e)=> e.stopPropagation(), {capture:true});
  document.getElementById('drawerPanel').addEventListener('pointerdown', (e)=> e.stopPropagation(), {capture:true});
</script>
</body>
</html>